<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Duty-Agent</title>
  <style>
    :root {
      --bg1: #ffffff;
      --bg2: #ffffff;
      --card: #ffffff;
      --line: #d5dde5;
      --text: #1f2937;
      --muted: #6b7280;
      --brand: #0f766e;
      --warn: #d97706;
      --danger: #b91c1c;
      --ok: #0f766e;
      --radius: 14px;
      --shadow: 0 12px 28px rgba(15,23,42,.08);
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; min-height: 100%; }
    body {
      font-family: "Noto Sans SC", "Microsoft YaHei UI", "Segoe UI", sans-serif;
      color: var(--text);
      background: #ffffff;
      padding: 18px;
    }
    .shell { max-width: 1500px; margin: 0 auto; }
    .topbar {
      display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 12px;
      padding: 14px 16px; border: 1px solid var(--line); border-radius: var(--radius);
      background: var(--card); box-shadow: var(--shadow); margin-bottom: 12px;
    }
    .topbar h1 { margin: 0; font-size: 23px; }
    .topbar p { margin: 3px 0 0; color: var(--muted); font-size: 12px; }
    .chip { border: 1px solid var(--line); border-radius: 999px; padding: 6px 10px; background: #fff; font-size: 12px; color: var(--muted); display: inline-flex; align-items: center; gap: 6px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: #9ca3af; }
    .dot.ok { background: var(--ok); }
    .dot.warn { background: var(--warn); }
    .dot.err { background: var(--danger); }
    .pill { border: 1px solid var(--line); border-radius: 999px; padding: 2px 8px; font-size: 11px; color: var(--muted); background: #fff; }
    .mono { font-family: "Consolas", "JetBrains Mono", "Courier New", monospace; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .col { display: contents; }
    .card {
      border: 1px solid var(--line); border-radius: var(--radius); background: var(--card);
      box-shadow: var(--shadow); overflow: hidden;
    }
    .head {
      display: flex; align-items: center; justify-content: space-between; gap: 8px;
      padding: 10px 12px; border-bottom: 1px solid var(--line); background: #ffffff;
    }
    .head h2 { margin: 0; font-size: 14px; }
    .body { padding: 11px 12px; display: grid; gap: 9px; }
    .row { display: grid; gap: 6px; }
    .two { grid-template-columns: 1fr 1fr; gap: 8px; }
    .three { grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    label { font-size: 12px; color: var(--muted); }
    input, select, textarea, button { font: inherit; font-size: 13px; }
    input, select, textarea {
      width: 100%; border: 1px solid var(--line); border-radius: 10px; background: #fff;
      color: var(--text); padding: 8px 9px; outline: none;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--brand); box-shadow: 0 0 0 3px rgba(15,118,110,.14); }
    textarea { min-height: 84px; resize: vertical; }
    button {
      border: 1px solid var(--line); border-radius: 10px; padding: 8px 10px; background: #fff;
      color: var(--text); cursor: pointer;
    }
    button.primary { background: linear-gradient(135deg, #0f766e, #115e59); color: #fff; border-color: transparent; }
    button.warn { background: linear-gradient(135deg, #d97706, #b45309); color: #fff; border-color: transparent; }
    button.danger { background: linear-gradient(135deg, #dc2626, #991b1b); color: #fff; border-color: transparent; }
    button.ghost { background: transparent; }
    .btns { display: flex; flex-wrap: wrap; gap: 7px; }
    .hint {
      font-size: 12px; color: var(--muted); line-height: 1.4;
      background: #ffffff; border: 1px dashed var(--line); border-radius: 10px; padding: 7px 8px;
    }
    .status {
      display: flex; align-items: center; gap: 8px; font-size: 12px;
      border: 1px solid var(--line); border-radius: 10px; padding: 7px 8px; background: #ffffff;
    }
    .status.ok { border-color: rgba(15,118,110,.35); }
    .status.err { border-color: rgba(185,28,28,.35); }
    .list select { min-height: 86px; }
    .table-wrap { overflow: auto; border: 1px solid var(--line); border-radius: 10px; background: #fff; }
    table { width: 100%; border-collapse: collapse; min-width: 420px; }
    th, td { border-bottom: 1px solid #edf1f5; text-align: left; font-size: 12px; padding: 8px 9px; vertical-align: top; }
    th { background: #f8fafc; color: #475569; position: sticky; top: 0; }
    tr.sel { background: rgba(15,118,110,.12); }
    #log {
      min-height: 140px; max-height: 300px; overflow: auto; border: 1px solid var(--line); border-radius: 10px;
      background: #ffffff; color: #1f2937; padding: 9px; font-size: 12px; line-height: 1.45; white-space: pre-wrap;
    }
    @media (max-width: 1200px) {
      .grid { grid-template-columns: 1fr; }
      .two, .three { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div class="shell">
  <section class="topbar">
    <div>
      <h1>Duty-Agent</h1>
      <p>值日排班管理（生产环境）。高频操作已置顶，页面按从上到下顺序组织。</p>
    </div>
  </section>

  <div class="grid">
    <div class="col">
      <section class="card">
        <div class="head"><h2>高频操作</h2><span id="runTag" class="pill mono">生产模式</span></div>
        <div class="body">
          <div class="row">
            <label for="instruction">排班指令</label>
            <textarea id="instruction" placeholder="例如：从今天开始排5天，每个区域每天2人，张三本周请假。"></textarea>
          </div>
          <div class="row">
            <label for="applyMode">应用模式</label>
            <select id="applyMode">
              <option value="append">追加</option>
              <option value="replace_future">替换未来</option>
              <option value="replace_overlap">替换重叠区间</option>
              <option value="replace_all">全部替换</option>
            </select>
          </div>
          <div class="btns">
            <button id="runBtn" class="primary">执行排班</button>
            <button id="loadBtn">加载数据</button>
            <button id="saveCfgBtn">保存配置</button>
            <button id="saveRosterBtn">保存名单</button>
          </div>
          <div id="runStatus" class="status"><span class="dot warn"></span><span>等待操作</span></div>
          <div class="hint">建议先“加载数据”同步宿主状态，再执行排班。</div>
        </div>
      </section>

      <section class="card">
        <div class="head"><h2>区域与通知模板</h2><span class="pill">配置列表</span></div>
        <div class="body">
          <div class="row two">
            <div class="row list">
              <label>清洁区域</label>
              <select id="areaList" size="6"></select>
              <div class="btns">
                <input id="newArea" type="text" placeholder="新增区域名">
                <button id="addArea">新增</button>
                <button id="delArea" class="danger">删除</button>
              </div>
            </div>
            <div class="row list">
              <label>通知模板</label>
              <select id="tplList" size="6"></select>
              <div class="btns">
                <input id="newTpl" type="text" placeholder="{scene}{status}...">
                <button id="addTpl">新增</button>
                <button id="delTpl" class="danger">删除</button>
              </div>
            </div>
          </div>
          <div class="hint">占位符：<span class="mono">{scene} {status} {date} {areas} {days} {per_day} {mode} {instruction} {message}</span></div>
        </div>
      </section>

    </div>

    <div class="col">
      <section class="card">
        <div class="head"><h2>核心配置</h2><span class="pill">配置</span></div>
        <div class="body">
          <div class="row"><label for="cfgPython">解释器路径</label><input id="cfgPython" type="text"></div>
          <div class="row"><label for="cfgApi">接口密钥（运行时）</label><input id="cfgApi" type="password"></div>
          <div class="row two">
            <div class="row"><label for="cfgBase">基础地址</label><input id="cfgBase" type="text"></div>
            <div class="row"><label for="cfgModel">模型</label><input id="cfgModel" type="text"></div>
          </div>
          <div class="row three">
            <div class="row"><label for="cfgAuto">自动排班</label><select id="cfgAuto"><option value="true">启用</option><option value="false">禁用</option></select></div>
            <div class="row"><label for="cfgDay">自动排班日</label><select id="cfgDay"><option value="Monday">周一</option><option value="Tuesday">周二</option><option value="Wednesday">周三</option><option value="Thursday">周四</option><option value="Friday">周五</option><option value="Saturday">周六</option><option value="Sunday">周日</option></select></div>
            <div class="row"><label for="cfgTime">自动排班时间</label><input id="cfgTime" type="time" step="60"></div>
          </div>
          <div class="row three">
            <div class="row"><label for="cfgDays">生成天数</label><input id="cfgDays" type="number" min="1" max="30"></div>
            <div class="row"><label for="cfgPer">每区域每日人数</label><input id="cfgPer" type="number" min="1" max="30"></div>
            <div class="row"><label for="cfgRefresh">组件刷新时间</label><input id="cfgRefresh" type="time" step="60"></div>
          </div>
          <div class="row two">
            <div class="row"><label for="cfgSkip">跳过周末</label><select id="cfgSkip"><option value="true">是</option><option value="false">否</option></select></div>
            <div class="row"><label for="cfgStart">从今天开始</label><select id="cfgStart"><option value="false">否</option><option value="true">是</option></select></div>
          </div>
          <div class="row"><label for="cfgRule">排班规则</label><textarea id="cfgRule"></textarea></div>
        </div>
      </section>

      <section class="card">
        <div class="head"><h2>名单管理(排序视图)</h2><span class="pill">名单</span></div>
        <div class="body">
          <div class="btns">
            <input id="newStudent" type="text" placeholder="学生姓名">
            <button id="addStudent">添加并自动分配ID</button>
            <button id="delStudent" class="danger">删除选中</button>
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>ID</th><th>姓名</th><th>下一次值日</th><th>总值日次数</th><th>启用</th></tr></thead>
              <tbody id="rosterBody"></tbody>
            </table>
          </div>
          <div class="hint">排序规则：下一次值日最早在前，未安排排最后。</div>
        </div>
      </section>
    </div>

    <div class="col">
      <section class="card">
        <div class="head"><h2>排班预览(动态区域)</h2><span class="pill">排班池</span></div>
        <div class="body">
          <div class="table-wrap"><table><thead id="scheduleHead"></thead><tbody id="scheduleBody"></tbody></table></div>
        </div>
      </section>

      <section class="card">
        <div class="head"><h2>组件固定视图预览</h2><span class="pill">教室 / 清洁区</span></div>
        <div class="body">
          <div class="table-wrap">
            <table>
              <thead><tr><th>日期</th><th>教室</th><th>清洁区</th></tr></thead>
              <tbody id="legacyBody"></tbody>
            </table>
          </div>
          <div class="hint">用于验证“组件页仍保持固定双区域”的显示行为。</div>
        </div>
      </section>

      <section class="card">
        <div class="head"><h2>日志</h2><span class="pill">运行记录</span></div>
        <div class="body">
          <div class="btns">
            <button id="clearLogBtn" class="ghost">清空日志</button>
            <button id="errorLogBtn" class="ghost">仅错误日志：关闭</button>
          </div>
          <div id="log" class="mono"></div>
          <div class="hint">宿主消息 action：<span class="mono">ready / load_all / save_config / save_roster / run_core</span></div>
        </div>
      </section>
    </div>
  </div>
</div>

<script>
'use strict';
const DEFAULT_CONFIG = {
  python_path: '.\\Assets_Duty\\python-embed\\python.exe',
  api_key: '',
  base_url: 'https://integrate.api.nvidia.com/v1',
  model: 'moonshotai/kimi-k2-thinking',
  enable_auto_run: false,
  auto_run_day: 'Monday',
  auto_run_time: '08:00',
  auto_run_coverage_days: 5,
  per_day: 2,
  skip_weekends: true,
  duty_rule: '',
  start_from_today: false,
  component_refresh_time: '08:00',
  area_names: ['教室', '清洁区'],
  notification_templates: ['{scene}{status}，日期：{date}，区域：{areas}']
};

const DEFAULT_ROSTER = [];

const DEFAULT_STATE = { seed_anchor: '', schedule_pool: [] };
const DAY = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
const hasBridge = !!(window.chrome && window.chrome.webview);

let selectedRosterId = null;
let logFilter = 'all';
const logEntries = [];
const LOG_MAX = 500;
const LOG_LEVEL_LABELS = {
  INFO: '信息',
  WARN: '警告',
  ERROR: '错误',
  SEND: '发送',
  RECV: '接收',
  OK: '成功'
};
let store = {
  config: normalizeConfig(DEFAULT_CONFIG),
  roster: normalizeRoster(DEFAULT_ROSTER),
  state: normalizeState(DEFAULT_STATE)
};

const $ = (id) => document.getElementById(id);

function clone(v) { return JSON.parse(JSON.stringify(v)); }
function int(v, d) { const n = Number(v); return Number.isFinite(n) ? Math.trunc(n) : d; }
function bool(v, d) {
  if (typeof v === 'boolean') return v;
  if (typeof v === 'string') {
    const s = v.trim().toLowerCase();
    if (['true', '1', 'yes', 'on'].includes(s)) return true;
    if (['false', '0', 'no', 'off'].includes(s)) return false;
  }
  return d;
}
function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }
function now() {
  const d = new Date();
  return `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}:${String(d.getSeconds()).padStart(2, '0')}`;
}
function today() { const d = new Date(); d.setHours(0, 0, 0, 0); return d; }
function addDays(date, n) { const d = new Date(date); d.setDate(d.getDate() + n); d.setHours(0, 0, 0, 0); return d; }
function dateIso(date) {
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const d = String(date.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}
function parseIso(s) {
  if (typeof s !== 'string' || !/^\d{4}-\d{2}-\d{2}$/.test(s)) return null;
  const [y, m, d] = s.split('-').map(Number);
  const dt = new Date(y, m - 1, d);
  dt.setHours(0, 0, 0, 0);
  return (dt.getFullYear() === y && dt.getMonth() === m - 1 && dt.getDate() === d) ? dt : null;
}
function html(s) {
  return String(s)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}
function list(input, fallback) {
  const seen = new Set();
  const out = [];
  if (Array.isArray(input)) {
    for (const raw of input) {
      const t = String(raw ?? '').trim();
      if (!t || seen.has(t)) continue;
      seen.add(t);
      out.push(t);
    }
  }
  return out.length ? out : clone(fallback);
}
function names(v) { return list(v, []); }

function normalizeConfig(input) {
  const raw = input && typeof input === 'object' ? input : {};
  return {
    python_path: String(raw.python_path ?? DEFAULT_CONFIG.python_path).trim() || DEFAULT_CONFIG.python_path,
    api_key: String(raw.api_key ?? ''),
    base_url: String(raw.base_url ?? DEFAULT_CONFIG.base_url).trim() || DEFAULT_CONFIG.base_url,
    model: String(raw.model ?? DEFAULT_CONFIG.model).trim() || DEFAULT_CONFIG.model,
    enable_auto_run: bool(raw.enable_auto_run, false),
    auto_run_day: String(raw.auto_run_day ?? 'Monday').trim() || 'Monday',
    auto_run_time: String(raw.auto_run_time ?? '08:00').trim() || '08:00',
    auto_run_coverage_days: clamp(int(raw.auto_run_coverage_days, 5), 1, 30),
    per_day: clamp(int(raw.per_day, 2), 1, 30),
    skip_weekends: bool(raw.skip_weekends, true),
    duty_rule: String(raw.duty_rule ?? ''),
    start_from_today: bool(raw.start_from_today, false),
    component_refresh_time: String(raw.component_refresh_time ?? '08:00').trim() || '08:00',
    area_names: list(raw.area_names, DEFAULT_CONFIG.area_names),
    notification_templates: list(raw.notification_templates, DEFAULT_CONFIG.notification_templates)
  };
}

function normalizeRoster(input) {
  if (!Array.isArray(input)) return [];
  const ids = new Set();
  const out = [];
  for (const r of input) {
    if (!r || typeof r !== 'object') continue;
    const id = int(r.id, NaN);
    const name = String(r.name ?? '').trim();
    if (!Number.isFinite(id) || id <= 0 || !name || ids.has(id)) continue;
    ids.add(id);
    out.push({ id, name, active: bool(r.active, true) });
  }
  out.sort((a, b) => a.id - b.id);
  return out;
}

function normalizeAssignments(raw) {
  const out = {};
  if (!raw || typeof raw !== 'object') return out;
  for (const [area, values] of Object.entries(raw)) {
    const key = String(area ?? '').trim();
    if (!key) continue;
    const arr = names(values);
    if (arr.length) out[key] = arr;
  }
  return out;
}

function normalizeItem(item) {
  if (!item || typeof item !== 'object') return null;
  const map = normalizeAssignments(item.area_assignments);
  const cls = names(item.classroom_students);
  const cln = names(item.cleaning_area_students);
  const stu = names(item.students);
  if (!Object.keys(map).length) {
    if (cls.length) map['教室'] = cls;
    if (cln.length) map['清洁区'] = cln;
    if (!cls.length && !cln.length && stu.length) map['教室'] = stu;
  }
  return {
    date: String(item.date ?? '').trim(),
    day: String(item.day ?? '').trim(),
    students: stu,
    classroom_students: cls,
    cleaning_area_students: cln,
    area_assignments: map
  };
}

function normalizeState(input) {
  const raw = input && typeof input === 'object' ? input : {};
  const state = { seed_anchor: String(raw.seed_anchor ?? ''), schedule_pool: [] };
  if (Array.isArray(raw.schedule_pool)) {
    for (const it of raw.schedule_pool) {
      const n = normalizeItem(it);
      if (n) state.schedule_pool.push(n);
    }
  }
  state.schedule_pool.sort((a, b) => a.date.localeCompare(b.date));
  return state;
}

function assignment(item, areaOrder = []) {
  const map = normalizeAssignments(item?.area_assignments);
  const ordered = {};
  for (const area of areaOrder) if (map[area]) ordered[area] = [...map[area]];
  for (const [k, v] of Object.entries(map)) if (!ordered[k]) ordered[k] = [...v];
  if (!Object.keys(ordered).length) {
    const cls = names(item?.classroom_students);
    const cln = names(item?.cleaning_area_students);
    const stu = names(item?.students);
    if (cls.length) ordered['教室'] = cls;
    if (cln.length) ordered['清洁区'] = cln;
    if (!cls.length && !cln.length && stu.length) ordered[areaOrder[0] || '教室'] = stu;
  }
  return ordered;
}

function log(level, msg, payload) {
  const upper = String(level || 'INFO').toUpperCase();
  const entry = {
    time: now(),
    level: upper,
    text: String(msg || ''),
    payload: payload === undefined ? null : payload
  };
  logEntries.push(entry);
  if (logEntries.length > LOG_MAX) {
    logEntries.splice(0, logEntries.length - LOG_MAX);
  }
  renderLogs();
}

function renderLogs() {
  const lines = [];
  for (const entry of logEntries) {
    if (logFilter === 'error' && entry.level !== 'ERROR') {
      continue;
    }
    const label = LOG_LEVEL_LABELS[entry.level] || entry.level;
    const extra = entry.payload == null ? '' : `\n${JSON.stringify(entry.payload, null, 2)}`;
    lines.push(`[${entry.time}] [${label}] ${entry.text}${extra}`);
  }
  $('log').textContent = lines.join('\n');
  $('log').scrollTop = $('log').scrollHeight;
}

function clearLogs() {
  logEntries.length = 0;
  renderLogs();
}

function toggleErrorLogFilter() {
  logFilter = logFilter === 'error' ? 'all' : 'error';
  $('errorLogBtn').textContent = logFilter === 'error' ? '仅错误日志：开启' : '仅错误日志：关闭';
  renderLogs();
  log('INFO', logFilter === 'error' ? '已切换为仅错误日志。' : '已切换为显示全部日志。');
}

function setStatus(type, text) {
  const tagMap = { ok: '成功', err: '错误', warn: '处理中' };
  $('runTag').textContent = tagMap[type] || '状态';
  const cls = type === 'ok' ? 'status ok' : type === 'err' ? 'status err' : 'status';
  const dot = type === 'ok' ? 'dot ok' : type === 'err' ? 'dot err' : 'dot warn';
  $('runStatus').className = cls;
  $('runStatus').innerHTML = `<span class="${dot}"></span><span>${html(text)}</span>`;
}

function bridgePost(action, payload) {
  const msg = { source: 'duty-agent-page', action, payload: payload || {} };
  if (!hasBridge) { log('WARN', `宿主不可用：${action}`, msg); return false; }
  window.chrome.webview.postMessage(msg);
  log('SEND', `发送到宿主：${action}`, msg.payload);
  return true;
}

function renderOptions(selectId, values) {
  const el = $(selectId);
  el.innerHTML = '';
  for (const v of values) {
    const op = document.createElement('option');
    op.value = v;
    op.textContent = v;
    el.appendChild(op);
  }
  if (el.options.length) el.selectedIndex = 0;
}

function renderConfig() {
  const c = store.config;
  $('cfgPython').value = c.python_path;
  $('cfgApi').value = c.api_key;
  $('cfgBase').value = c.base_url;
  $('cfgModel').value = c.model;
  $('cfgAuto').value = String(c.enable_auto_run);
  $('cfgDay').value = c.auto_run_day;
  $('cfgTime').value = c.auto_run_time;
  $('cfgDays').value = c.auto_run_coverage_days;
  $('cfgPer').value = c.per_day;
  $('cfgRefresh').value = c.component_refresh_time;
  $('cfgSkip').value = String(c.skip_weekends);
  $('cfgStart').value = String(c.start_from_today);
  $('cfgRule').value = c.duty_rule;
  renderOptions('areaList', c.area_names);
  renderOptions('tplList', c.notification_templates);
}

function syncConfigFromForm() {
  store.config = normalizeConfig({
    python_path: $('cfgPython').value,
    api_key: $('cfgApi').value,
    base_url: $('cfgBase').value,
    model: $('cfgModel').value,
    enable_auto_run: $('cfgAuto').value,
    auto_run_day: $('cfgDay').value,
    auto_run_time: $('cfgTime').value,
    auto_run_coverage_days: $('cfgDays').value,
    per_day: $('cfgPer').value,
    skip_weekends: $('cfgSkip').value,
    duty_rule: $('cfgRule').value,
    start_from_today: $('cfgStart').value,
    component_refresh_time: $('cfgRefresh').value,
    area_names: Array.from($('areaList').options).map((x) => x.value),
    notification_templates: Array.from($('tplList').options).map((x) => x.value)
  });
}

function rosterStats() {
  const cnt = new Map();
  const nxt = new Map();
  const td = today();
  const pool = [...store.state.schedule_pool].sort((a, b) => a.date.localeCompare(b.date));

  for (const item of pool) {
    const d = parseIso(item.date);
    if (!d) continue;
    const set = new Set();
    const map = assignment(item, store.config.area_names);
    for (const arr of Object.values(map)) for (const n of arr) if (n) set.add(n);
    for (const n of set) {
      cnt.set(n, (cnt.get(n) || 0) + 1);
      if (d >= td) {
        const old = nxt.get(n);
        if (!old || d < old) nxt.set(n, d);
      }
    }
  }

  const rows = store.roster.map((r) => ({
    id: r.id,
    name: r.name,
    active: r.active,
    next: nxt.get(r.name) ? dateIso(nxt.get(r.name)) : '未安排',
    count: cnt.get(r.name) || 0
  }));

  rows.sort((a, b) => {
    const au = a.next === '未安排';
    const bu = b.next === '未安排';
    if (au !== bu) return au ? 1 : -1;
    if (!au && a.next !== b.next) return a.next.localeCompare(b.next);
    return a.id - b.id;
  });
  return rows;
}

function renderRoster() {
  const rows = rosterStats();
  $('rosterBody').innerHTML = '';
  for (const r of rows) {
    const tr = document.createElement('tr');
    tr.dataset.id = String(r.id);
    if (r.id === selectedRosterId) tr.className = 'sel';
    tr.innerHTML = `<td class="mono">${r.id}</td><td>${html(r.name)}</td><td class="mono">${html(r.next)}</td><td class="mono">${r.count}</td><td>${r.active ? '是' : '否'}</td>`;
    tr.addEventListener('click', () => { selectedRosterId = r.id; renderRoster(); });
    $('rosterBody').appendChild(tr);
  }
}

function allAreaNames() {
  const out = [...store.config.area_names];
  const set = new Set(out);
  for (const item of store.state.schedule_pool) {
    for (const k of Object.keys(assignment(item, out))) {
      if (!set.has(k)) { set.add(k); out.push(k); }
    }
  }
  return out;
}
function renderSchedule() {
  const areas = allAreaNames();
  $('scheduleHead').innerHTML = `<tr><th>日期</th><th>星期</th>${areas.map((a) => `<th>${html(a)}</th>`).join('')}</tr>`;
  const pool = [...store.state.schedule_pool].sort((a, b) => a.date.localeCompare(b.date));
  if (!pool.length) {
    $('scheduleBody').innerHTML = `<tr><td colspan="${2 + areas.length}">暂无排班数据</td></tr>`;
    return;
  }
  $('scheduleBody').innerHTML = '';
  for (const it of pool) {
    const map = assignment(it, areas);
    const tr = document.createElement('tr');
    const cells = [`<td class="mono">${html(it.date)}</td>`, `<td class="mono">${html(it.day)}</td>`];
    for (const a of areas) cells.push(`<td>${html((map[a] || []).join(', ') || '-')}</td>`);
    tr.innerHTML = cells.join('');
    $('scheduleBody').appendChild(tr);
  }
}

function renderLegacy() {
  const pool = [...store.state.schedule_pool].sort((a, b) => a.date.localeCompare(b.date));
  $('legacyBody').innerHTML = '';
  if (!pool.length) {
    $('legacyBody').innerHTML = '<tr><td colspan="3">暂无排班数据</td></tr>';
    return;
  }
  for (const it of pool) {
    const map = assignment(it, store.config.area_names);
    const c1 = map['教室'] || names(it.classroom_students);
    const c2 = map['清洁区'] || names(it.cleaning_area_students);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="mono">${html(it.date)}</td><td>${html(c1.join(', ') || '-')}</td><td>${html(c2.join(', ') || '-')}</td>`;
    $('legacyBody').appendChild(tr);
  }
}

function renderAll() {
  renderConfig();
  renderRoster();
  renderSchedule();
  renderLegacy();
}

function startDateFromConfig() {
  if (store.config.start_from_today) return today();
  const pool = [...store.state.schedule_pool].sort((a, b) => a.date.localeCompare(b.date));
  if (pool.length) {
    const last = parseIso(pool[pool.length - 1].date);
    if (last) return addDays(last, 1);
  }
  return addDays(today(), 1);
}

function targetDates(start, days, skipWeekends) {
  const out = [];
  let d = new Date(start);
  while (out.length < days) {
    const w = d.getDay();
    if (!(skipWeekends && (w === 0 || w === 6))) out.push(new Date(d));
    d = addDays(d, 1);
  }
  return out;
}

function lastAssignedName(pool, areas, applyMode, startDate) {
  const start = dateIso(startDate);
  const src = applyMode === 'append' ? pool : pool.filter((x) => x.date < start);
  for (let i = src.length - 1; i >= 0; i--) {
    const map = assignment(src[i], areas);
    const keys = [...areas, ...Object.keys(map).filter((k) => !areas.includes(k))];
    for (const k of keys) {
      const arr = map[k] || [];
      if (arr.length) return arr[arr.length - 1];
    }
  }
  return null;
}

function mergeSchedule(existing, generated, applyMode, startDate) {
  const cur = [...existing].sort((a, b) => a.date.localeCompare(b.date));
  const start = dateIso(startDate);
  const td = dateIso(today());
  if (applyMode === 'replace_all') return [...generated];
  if (applyMode === 'replace_future') return [...cur.filter((x) => x.date <= td), ...generated].sort((a, b) => a.date.localeCompare(b.date));
  if (applyMode === 'replace_overlap') {
    const end = generated.length ? generated[generated.length - 1].date : start;
    return [...cur.filter((x) => x.date < start || x.date > end), ...generated].sort((a, b) => a.date.localeCompare(b.date));
  }
  return [...cur, ...generated];
}

function renderTpl(tpl, tokens) {
  return String(tpl || '').replace(/\{([a-zA-Z0-9_]+)\}/g, (_, k) => (k in tokens ? tokens[k] : `{${k}}`)).trim();
}

function runBridge() {
  syncConfigFromForm();
  const instruction = $('instruction').value.trim();
  const applyMode = $('applyMode').value;
  if (!instruction) {
    setStatus('err', '请输入排班指令。');
    log('ERROR', '宿主排班失败：排班指令为空。');
    return;
  }
  log('INFO', '开始请求宿主执行排班。', { mode: applyMode });
  const ok = bridgePost('run_core', { instruction, apply_mode: applyMode, config: store.config });
  setStatus(ok ? 'warn' : 'err', ok ? '已发送排班请求到宿主。' : '宿主不可用，无法发送排班请求。');
  if (!ok) {
    log('ERROR', '宿主排班失败：宿主不可用。');
  }
}

function addArea() {
  const name = $('newArea').value.trim();
  if (!name) {
    setStatus('err', '区域名不能为空。');
    log('ERROR', '新增区域失败：区域名为空。');
    return;
  }
  syncConfigFromForm();
  if (store.config.area_names.includes(name)) {
    setStatus('err', '区域已存在。');
    log('ERROR', '新增区域失败：区域已存在。', { area: name });
    return;
  }
  store.config.area_names.push(name);
  $('newArea').value = '';
  renderConfig();
  renderSchedule();
  setStatus('ok', `已新增区域：${name}`);
  log('OK', '已新增区域。', { area: name });
}

function delArea() {
  syncConfigFromForm();
  const v = $('areaList').value;
  if (!v) {
    setStatus('err', '请先选择区域。');
    log('ERROR', '删除区域失败：未选择区域。');
    return;
  }
  if (store.config.area_names.length <= 1) {
    setStatus('err', '至少保留一个区域。');
    log('ERROR', '删除区域失败：区域数量不能少于 1。');
    return;
  }
  store.config.area_names = store.config.area_names.filter((x) => x !== v);
  renderConfig();
  renderSchedule();
  setStatus('ok', `已删除区域：${v}`);
  log('OK', '已删除区域。', { area: v });
}

function addTpl() {
  const text = $('newTpl').value.trim();
  if (!text) {
    setStatus('err', '模板不能为空。');
    log('ERROR', '新增通知模板失败：模板为空。');
    return;
  }
  syncConfigFromForm();
  if (store.config.notification_templates.includes(text)) {
    setStatus('err', '模板已存在。');
    log('ERROR', '新增通知模板失败：模板已存在。');
    return;
  }
  store.config.notification_templates.push(text);
  $('newTpl').value = '';
  renderConfig();
  setStatus('ok', '通知模板已新增。');
  log('OK', '已新增通知模板。', { template: text });
}

function delTpl() {
  syncConfigFromForm();
  const v = $('tplList').value;
  if (!v) {
    setStatus('err', '请先选择模板。');
    log('ERROR', '删除通知模板失败：未选择模板。');
    return;
  }
  if (store.config.notification_templates.length <= 1) {
    setStatus('err', '至少保留一个模板。');
    log('ERROR', '删除通知模板失败：模板数量不能少于 1。');
    return;
  }
  store.config.notification_templates = store.config.notification_templates.filter((x) => x !== v);
  renderConfig();
  setStatus('ok', '通知模板已删除。');
  log('OK', '已删除通知模板。', { template: v });
}

function addStudent() {
  const name = $('newStudent').value.trim();
  if (!name) {
    setStatus('err', '学生姓名不能为空。');
    log('ERROR', '新增学生失败：姓名为空。');
    return;
  }
  const nextId = store.roster.length ? Math.max(...store.roster.map((x) => x.id)) + 1 : 1;
  store.roster.push({ id: nextId, name, active: true });
  $('newStudent').value = '';
  selectedRosterId = nextId;
  renderRoster();
  setStatus('ok', `已添加学生：${name} (ID ${nextId})`);
  log('OK', '已添加学生。', { id: nextId, name });
}

function delStudent() {
  if (selectedRosterId == null) {
    setStatus('err', '请先在表格中选择学生。');
    log('ERROR', '删除学生失败：未选择学生。');
    return;
  }
  const before = store.roster.length;
  store.roster = store.roster.filter((x) => x.id !== selectedRosterId);
  if (store.roster.length === before) {
    setStatus('err', '未找到选中学生。');
    log('ERROR', '删除学生失败：未找到对应 ID。', { id: selectedRosterId });
    return;
  }
  selectedRosterId = null;
  renderRoster();
  setStatus('ok', '已删除选中学生。');
  log('OK', '已删除学生。');
}

function applyHost(data) {
  if (!data || typeof data !== 'object') {
    log('WARN', '收到无效宿主消息。', data);
    return;
  }
  let changed = false;
  if ('config' in data) { store.config = normalizeConfig(data.config); changed = true; }
  if ('roster' in data) { store.roster = normalizeRoster(data.roster); changed = true; }
  if ('state' in data) { store.state = normalizeState(data.state); changed = true; }
  if (data.type === 'run_result') {
    const ok = !!data.success;
    const message = data.message || '未知错误';
    setStatus(ok ? 'ok' : 'err', ok ? '宿主排班成功。' : `宿主排班失败：${message}`);
    log(ok ? 'OK' : 'ERROR', ok ? '宿主排班成功。' : '宿主排班失败。', { message });
  }
  if (data.type === 'error') {
    log('ERROR', `宿主返回错误：${data.code || '未知错误'}`, data);
  }
  if (changed) {
    selectedRosterId = null;
    renderAll();
    log('INFO', '已应用宿主返回的最新数据。');
  }
}

function bind() {
  $('runBtn').addEventListener('click', runBridge);
  $('loadBtn').addEventListener('click', () => {
    log('INFO', '触发加载数据。');
    const ok = bridgePost('load_all', {});
    setStatus(ok ? 'warn' : 'err', ok ? '已请求宿主加载数据。' : '宿主不可用，无法加载。');
    if (!ok) {
      log('ERROR', '加载数据失败：宿主不可用。');
    }
  });
  $('saveCfgBtn').addEventListener('click', () => {
    syncConfigFromForm();
    log('INFO', '触发保存配置。');
    const ok = bridgePost('save_config', { config: store.config });
    setStatus(ok ? 'warn' : 'err', ok ? '配置已发送到宿主。' : '宿主不可用，无法保存配置。');
    if (!ok) {
      log('ERROR', '保存配置失败：宿主不可用。');
    }
  });
  $('saveRosterBtn').addEventListener('click', () => {
    log('INFO', '触发保存名单。');
    const ok = bridgePost('save_roster', { roster: store.roster });
    setStatus(ok ? 'warn' : 'err', ok ? '名单已发送到宿主。' : '宿主不可用，无法保存名单。');
    if (!ok) {
      log('ERROR', '保存名单失败：宿主不可用。');
    }
  });

  $('addArea').addEventListener('click', addArea);
  $('delArea').addEventListener('click', delArea);
  $('addTpl').addEventListener('click', addTpl);
  $('delTpl').addEventListener('click', delTpl);
  $('addStudent').addEventListener('click', addStudent);
  $('delStudent').addEventListener('click', delStudent);

  $('clearLogBtn').addEventListener('click', () => {
    clearLogs();
    setStatus('ok', '日志已清空。');
  });
  $('errorLogBtn').addEventListener('click', toggleErrorLogFilter);

  if (hasBridge) {
    window.chrome.webview.addEventListener('message', (event) => {
      applyHost(event.data);
      log('INFO', '已接收宿主消息。');
    });
  }
}

bind();
renderAll();
if (hasBridge) {
  bridgePost('ready', {
    features: ['config', 'roster', 'state', 'run'],
    version: 'prod-html-1'
  });
  setStatus('warn', '已连接宿主，等待数据同步。');
} else {
  setStatus('warn', '未检测到宿主，当前仅可查看页面。');
}
log('INFO', '页面初始化完成。');
</script>
</body>
</html>

