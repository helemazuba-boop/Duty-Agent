<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Duty-Agent 测试控制台</title>
  <style>
    :root {
      --bg1: #edf3f7;
      --bg2: #f8f2e7;
      --card: rgba(255,255,255,.88);
      --line: #d5dde5;
      --text: #1f2937;
      --muted: #6b7280;
      --brand: #0f766e;
      --warn: #d97706;
      --danger: #b91c1c;
      --ok: #0f766e;
      --radius: 14px;
      --shadow: 0 12px 28px rgba(15,23,42,.08);
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; min-height: 100%; }
    body {
      font-family: "Noto Sans SC", "Microsoft YaHei UI", "Segoe UI", sans-serif;
      color: var(--text);
      background:
        radial-gradient(900px 460px at 8% -10%, rgba(15,118,110,.18), transparent),
        radial-gradient(820px 420px at 94% -15%, rgba(217,119,6,.16), transparent),
        linear-gradient(145deg, var(--bg1), var(--bg2));
      padding: 18px;
    }
    .shell { max-width: 1500px; margin: 0 auto; }
    .topbar {
      display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 12px;
      padding: 14px 16px; border: 1px solid var(--line); border-radius: var(--radius);
      background: var(--card); box-shadow: var(--shadow); margin-bottom: 12px;
    }
    .topbar h1 { margin: 0; font-size: 23px; }
    .topbar p { margin: 3px 0 0; color: var(--muted); font-size: 12px; }
    .mode { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .chip { border: 1px solid var(--line); border-radius: 999px; padding: 6px 10px; background: #fff; font-size: 12px; color: var(--muted); display: inline-flex; align-items: center; gap: 6px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: #9ca3af; }
    .dot.ok { background: var(--ok); }
    .dot.warn { background: var(--warn); }
    .dot.err { background: var(--danger); }
    .pill { border: 1px solid var(--line); border-radius: 999px; padding: 2px 8px; font-size: 11px; color: var(--muted); background: #fff; }
    .mono { font-family: "Consolas", "JetBrains Mono", "Courier New", monospace; }
    .grid { display: grid; grid-template-columns: 1.1fr 1.2fr 1.4fr; gap: 12px; }
    .col { display: grid; gap: 12px; align-content: start; }
    .card {
      border: 1px solid var(--line); border-radius: var(--radius); background: var(--card);
      box-shadow: var(--shadow); overflow: hidden;
    }
    .head {
      display: flex; align-items: center; justify-content: space-between; gap: 8px;
      padding: 10px 12px; border-bottom: 1px solid var(--line); background: rgba(255,255,255,.7);
    }
    .head h2 { margin: 0; font-size: 14px; }
    .body { padding: 11px 12px; display: grid; gap: 9px; }
    .row { display: grid; gap: 6px; }
    .two { grid-template-columns: 1fr 1fr; gap: 8px; }
    .three { grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    label { font-size: 12px; color: var(--muted); }
    input, select, textarea, button { font: inherit; font-size: 13px; }
    input, select, textarea {
      width: 100%; border: 1px solid var(--line); border-radius: 10px; background: #fff;
      color: var(--text); padding: 8px 9px; outline: none;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--brand); box-shadow: 0 0 0 3px rgba(15,118,110,.14); }
    textarea { min-height: 84px; resize: vertical; }
    button {
      border: 1px solid var(--line); border-radius: 10px; padding: 8px 10px; background: #fff;
      color: var(--text); cursor: pointer;
    }
    button.primary { background: linear-gradient(135deg, #0f766e, #115e59); color: #fff; border-color: transparent; }
    button.warn { background: linear-gradient(135deg, #d97706, #b45309); color: #fff; border-color: transparent; }
    button.danger { background: linear-gradient(135deg, #dc2626, #991b1b); color: #fff; border-color: transparent; }
    button.ghost { background: transparent; }
    .btns { display: flex; flex-wrap: wrap; gap: 7px; }
    .hint {
      font-size: 12px; color: var(--muted); line-height: 1.4;
      background: rgba(255,255,255,.56); border: 1px dashed var(--line); border-radius: 10px; padding: 7px 8px;
    }
    .status {
      display: flex; align-items: center; gap: 8px; font-size: 12px;
      border: 1px solid var(--line); border-radius: 10px; padding: 7px 8px; background: rgba(255,255,255,.6);
    }
    .status.ok { border-color: rgba(15,118,110,.35); }
    .status.err { border-color: rgba(185,28,28,.35); }
    .list select { min-height: 86px; }
    .table-wrap { overflow: auto; border: 1px solid var(--line); border-radius: 10px; background: #fff; }
    table { width: 100%; border-collapse: collapse; min-width: 420px; }
    th, td { border-bottom: 1px solid #edf1f5; text-align: left; font-size: 12px; padding: 8px 9px; vertical-align: top; }
    th { background: #f8fafc; color: #475569; position: sticky; top: 0; }
    tr.sel { background: rgba(15,118,110,.12); }
    #noticeList { display: grid; gap: 7px; max-height: 160px; overflow: auto; }
    .notice { border: 1px solid var(--line); border-left: 4px solid var(--brand); border-radius: 10px; padding: 7px 8px; background: #fff; font-size: 12px; }
    .notice.fail { border-left-color: var(--danger); }
    #snapshot { min-height: 170px; font-size: 12px; }
    #log {
      min-height: 140px; max-height: 300px; overflow: auto; border: 1px solid var(--line); border-radius: 10px;
      background: #0f172a; color: #dbeafe; padding: 9px; font-size: 12px; line-height: 1.45; white-space: pre-wrap;
    }
    @media (max-width: 1200px) {
      .grid { grid-template-columns: 1fr; }
      .two, .three { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div class="shell">
  <section class="topbar">
    <div>
      <h1>Duty-Agent 测试控制台</h1>
      <p>覆盖配置、多区域、名单、通知模板、排班执行、组件固定视图与快照回归。</p>
    </div>
    <div class="mode">
      <label for="mode">模式</label>
      <select id="mode" style="width:170px">
        <option value="mock">Mock(本地模拟)</option>
        <option value="bridge">Bridge(WebView宿主)</option>
      </select>
      <span class="chip"><span id="bridgeDot" class="dot"></span><span id="bridgeText">Bridge 未启用</span></span>
      <span id="runtimeTag" class="pill mono">runtime: mock</span>
    </div>
  </section>

  <div class="grid">
    <div class="col">
      <section class="card">
        <div class="head"><h2>运行与保存</h2><span id="runTag" class="pill mono">idle</span></div>
        <div class="body">
          <div class="row">
            <label for="instruction">排班指令</label>
            <textarea id="instruction" placeholder="例如：从今天开始排5天，每个区域每天2人，张三本周请假。"></textarea>
          </div>
          <div class="row two">
            <div class="row">
              <label for="applyMode">应用模式</label>
              <select id="applyMode">
                <option value="append">append</option>
                <option value="replace_future">replace_future</option>
                <option value="replace_overlap">replace_overlap</option>
                <option value="replace_all">replace_all</option>
              </select>
            </div>
            <div class="row">
              <label for="runDetail">运行详情(通知附加)</label>
              <input id="runDetail" type="text" placeholder="例如：mock run success">
            </div>
          </div>
          <div class="btns">
            <button id="runBtn" class="primary">执行排班</button>
            <button id="loadBtn">加载数据</button>
            <button id="saveCfgBtn">保存配置</button>
            <button id="saveRosterBtn">保存名单</button>
          </div>
          <div id="runStatus" class="status"><span class="dot warn"></span><span>等待操作</span></div>
          <div class="hint">导出快照会把 API Key 掩码为 <span class="mono">***runtime-only***</span>，用于校验“密钥仅运行时使用”的流程。</div>
        </div>
      </section>

      <section class="card">
        <div class="head"><h2>区域与通知模板</h2><span class="pill">Config Lists</span></div>
        <div class="body">
          <div class="row two">
            <div class="row list">
              <label>清洁区域</label>
              <select id="areaList" size="6"></select>
              <div class="btns">
                <input id="newArea" type="text" placeholder="新增区域名">
                <button id="addArea">新增</button>
                <button id="delArea" class="danger">删除</button>
              </div>
            </div>
            <div class="row list">
              <label>通知模板</label>
              <select id="tplList" size="6"></select>
              <div class="btns">
                <input id="newTpl" type="text" placeholder="{scene}{status}...">
                <button id="addTpl">新增</button>
                <button id="delTpl" class="danger">删除</button>
              </div>
            </div>
          </div>
          <div class="hint">占位符：<span class="mono">{scene} {status} {date} {areas} {days} {per_day} {mode} {instruction} {message}</span></div>
        </div>
      </section>

      <section class="card">
        <div class="head"><h2>通知预览与触发</h2><span class="pill">Notification</span></div>
        <div class="body">
          <div class="row three">
            <div class="row">
              <label for="nScene">场景</label>
              <select id="nScene"><option value="manual">manual</option><option value="auto">auto</option></select>
            </div>
            <div class="row">
              <label for="nStatus">状态</label>
              <select id="nStatus"><option value="success">success</option><option value="fail">fail</option></select>
            </div>
            <div class="row">
              <label for="nDuration">持续秒数</label>
              <input id="nDuration" type="number" min="1" max="30" value="7">
            </div>
          </div>
          <div class="row"><label for="nMsg">消息</label><input id="nMsg" type="text" placeholder="例如：API key missing"></div>
          <div class="btns">
            <button id="previewNotice">本地预览</button>
            <button id="sendNotice" class="warn">发送到宿主</button>
          </div>
          <div id="noticeList"></div>
        </div>
      </section>
    </div>

    <div class="col">
      <section class="card">
        <div class="head"><h2>核心配置</h2><span class="pill">DutyConfig</span></div>
        <div class="body">
          <div class="row"><label for="cfgPython">python_path</label><input id="cfgPython" type="text"></div>
          <div class="row"><label for="cfgApi">api_key(运行时)</label><input id="cfgApi" type="password"></div>
          <div class="row two">
            <div class="row"><label for="cfgBase">base_url</label><input id="cfgBase" type="text"></div>
            <div class="row"><label for="cfgModel">model</label><input id="cfgModel" type="text"></div>
          </div>
          <div class="row three">
            <div class="row"><label for="cfgAuto">enable_auto_run</label><select id="cfgAuto"><option value="true">true</option><option value="false">false</option></select></div>
            <div class="row"><label for="cfgDay">auto_run_day</label><select id="cfgDay"><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option></select></div>
            <div class="row"><label for="cfgTime">auto_run_time</label><input id="cfgTime" type="time" step="60"></div>
          </div>
          <div class="row three">
            <div class="row"><label for="cfgDays">auto_run_coverage_days</label><input id="cfgDays" type="number" min="1" max="30"></div>
            <div class="row"><label for="cfgPer">per_day</label><input id="cfgPer" type="number" min="1" max="30"></div>
            <div class="row"><label for="cfgRefresh">component_refresh_time</label><input id="cfgRefresh" type="time" step="60"></div>
          </div>
          <div class="row two">
            <div class="row"><label for="cfgSkip">skip_weekends</label><select id="cfgSkip"><option value="true">true</option><option value="false">false</option></select></div>
            <div class="row"><label for="cfgStart">start_from_today</label><select id="cfgStart"><option value="false">false</option><option value="true">true</option></select></div>
          </div>
          <div class="row"><label for="cfgRule">duty_rule</label><textarea id="cfgRule"></textarea></div>
        </div>
      </section>

      <section class="card">
        <div class="head"><h2>名单管理(排序视图)</h2><span class="pill">Roster</span></div>
        <div class="body">
          <div class="btns">
            <input id="newStudent" type="text" placeholder="学生姓名">
            <button id="addStudent">添加并自动分配ID</button>
            <button id="delStudent" class="danger">删除选中</button>
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>ID</th><th>姓名</th><th>下一次值日</th><th>总值日次数</th><th>active</th></tr></thead>
              <tbody id="rosterBody"></tbody>
            </table>
          </div>
          <div class="hint">排序规则：下一次值日最早在前，未安排排最后。</div>
        </div>
      </section>
    </div>

    <div class="col">
      <section class="card">
        <div class="head"><h2>排班预览(动态区域)</h2><span class="pill">state.schedule_pool</span></div>
        <div class="body">
          <div class="table-wrap"><table><thead id="scheduleHead"></thead><tbody id="scheduleBody"></tbody></table></div>
        </div>
      </section>

      <section class="card">
        <div class="head"><h2>组件固定视图预览</h2><span class="pill">教室 / 清洁区</span></div>
        <div class="body">
          <div class="table-wrap">
            <table>
              <thead><tr><th>日期</th><th>教室</th><th>清洁区</th></tr></thead>
              <tbody id="legacyBody"></tbody>
            </table>
          </div>
          <div class="hint">用于验证“组件页仍保持固定双区域”的显示行为。</div>
        </div>
      </section>

      <section class="card">
        <div class="head"><h2>快照与日志</h2><span class="pill">Import / Export</span></div>
        <div class="body">
          <div class="btns">
            <button id="exportBtn">导出快照(JSON)</button>
            <button id="importBtn">导入快照(JSON)</button>
            <button id="resetBtn" class="ghost">重置默认</button>
          </div>
          <textarea id="snapshot" class="mono" placeholder="导入或查看快照 JSON"></textarea>
          <div id="log" class="mono"></div>
          <div class="hint">Bridge 消息 action：<span class="mono">ready / load_all / save_config / save_roster / run_core / publish_notification</span></div>
        </div>
      </section>
    </div>
  </div>
</div>

<script>
'use strict';
const DEFAULT_CONFIG = {
  python_path: '.\\Assets_Duty\\python-embed\\python.exe',
  api_key: '',
  base_url: 'https://integrate.api.nvidia.com/v1',
  model: 'moonshotai/kimi-k2-thinking',
  enable_auto_run: false,
  auto_run_day: 'Monday',
  auto_run_time: '08:00',
  auto_run_coverage_days: 5,
  per_day: 2,
  skip_weekends: true,
  duty_rule: '',
  start_from_today: false,
  component_refresh_time: '08:00',
  area_names: ['教室', '清洁区'],
  notification_templates: ['{scene}{status}，日期：{date}，区域：{areas}']
};

const DEFAULT_ROSTER = [
  { id: 1, name: '张三', active: true },
  { id: 2, name: '李四', active: true },
  { id: 3, name: '王五', active: true },
  { id: 4, name: '赵六', active: true },
  { id: 5, name: '孙七', active: true },
  { id: 6, name: '周八', active: true }
];

const DEFAULT_STATE = { seed_anchor: '', schedule_pool: [] };
const DAY = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
const API_KEY_MASK = '***runtime-only***';
const hasBridge = !!(window.chrome && window.chrome.webview);

let runtimeMode = 'mock';
let selectedRosterId = null;
let store = {
  config: normalizeConfig(DEFAULT_CONFIG),
  roster: normalizeRoster(DEFAULT_ROSTER),
  state: normalizeState(DEFAULT_STATE)
};

const $ = (id) => document.getElementById(id);

function clone(v) { return JSON.parse(JSON.stringify(v)); }
function int(v, d) { const n = Number(v); return Number.isFinite(n) ? Math.trunc(n) : d; }
function bool(v, d) {
  if (typeof v === 'boolean') return v;
  if (typeof v === 'string') {
    const s = v.trim().toLowerCase();
    if (['true', '1', 'yes', 'on'].includes(s)) return true;
    if (['false', '0', 'no', 'off'].includes(s)) return false;
  }
  return d;
}
function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }
function now() {
  const d = new Date();
  return `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}:${String(d.getSeconds()).padStart(2, '0')}`;
}
function today() { const d = new Date(); d.setHours(0, 0, 0, 0); return d; }
function addDays(date, n) { const d = new Date(date); d.setDate(d.getDate() + n); d.setHours(0, 0, 0, 0); return d; }
function dateIso(date) {
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const d = String(date.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}
function parseIso(s) {
  if (typeof s !== 'string' || !/^\d{4}-\d{2}-\d{2}$/.test(s)) return null;
  const [y, m, d] = s.split('-').map(Number);
  const dt = new Date(y, m - 1, d);
  dt.setHours(0, 0, 0, 0);
  return (dt.getFullYear() === y && dt.getMonth() === m - 1 && dt.getDate() === d) ? dt : null;
}
function html(s) {
  return String(s)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}
function list(input, fallback) {
  const seen = new Set();
  const out = [];
  if (Array.isArray(input)) {
    for (const raw of input) {
      const t = String(raw ?? '').trim();
      if (!t || seen.has(t)) continue;
      seen.add(t);
      out.push(t);
    }
  }
  return out.length ? out : clone(fallback);
}
function names(v) { return list(v, []); }

function normalizeConfig(input) {
  const raw = input && typeof input === 'object' ? input : {};
  return {
    python_path: String(raw.python_path ?? DEFAULT_CONFIG.python_path).trim() || DEFAULT_CONFIG.python_path,
    api_key: String(raw.api_key ?? ''),
    base_url: String(raw.base_url ?? DEFAULT_CONFIG.base_url).trim() || DEFAULT_CONFIG.base_url,
    model: String(raw.model ?? DEFAULT_CONFIG.model).trim() || DEFAULT_CONFIG.model,
    enable_auto_run: bool(raw.enable_auto_run, false),
    auto_run_day: String(raw.auto_run_day ?? 'Monday').trim() || 'Monday',
    auto_run_time: String(raw.auto_run_time ?? '08:00').trim() || '08:00',
    auto_run_coverage_days: clamp(int(raw.auto_run_coverage_days, 5), 1, 30),
    per_day: clamp(int(raw.per_day, 2), 1, 30),
    skip_weekends: bool(raw.skip_weekends, true),
    duty_rule: String(raw.duty_rule ?? ''),
    start_from_today: bool(raw.start_from_today, false),
    component_refresh_time: String(raw.component_refresh_time ?? '08:00').trim() || '08:00',
    area_names: list(raw.area_names, DEFAULT_CONFIG.area_names),
    notification_templates: list(raw.notification_templates, DEFAULT_CONFIG.notification_templates)
  };
}

function normalizeRoster(input) {
  if (!Array.isArray(input)) return [];
  const ids = new Set();
  const out = [];
  for (const r of input) {
    if (!r || typeof r !== 'object') continue;
    const id = int(r.id, NaN);
    const name = String(r.name ?? '').trim();
    if (!Number.isFinite(id) || id <= 0 || !name || ids.has(id)) continue;
    ids.add(id);
    out.push({ id, name, active: bool(r.active, true) });
  }
  out.sort((a, b) => a.id - b.id);
  return out;
}

function normalizeAssignments(raw) {
  const out = {};
  if (!raw || typeof raw !== 'object') return out;
  for (const [area, values] of Object.entries(raw)) {
    const key = String(area ?? '').trim();
    if (!key) continue;
    const arr = names(values);
    if (arr.length) out[key] = arr;
  }
  return out;
}

function normalizeItem(item) {
  if (!item || typeof item !== 'object') return null;
  const map = normalizeAssignments(item.area_assignments);
  const cls = names(item.classroom_students);
  const cln = names(item.cleaning_area_students);
  const stu = names(item.students);
  if (!Object.keys(map).length) {
    if (cls.length) map['教室'] = cls;
    if (cln.length) map['清洁区'] = cln;
    if (!cls.length && !cln.length && stu.length) map['教室'] = stu;
  }
  return {
    date: String(item.date ?? '').trim(),
    day: String(item.day ?? '').trim(),
    students: stu,
    classroom_students: cls,
    cleaning_area_students: cln,
    area_assignments: map
  };
}

function normalizeState(input) {
  const raw = input && typeof input === 'object' ? input : {};
  const state = { seed_anchor: String(raw.seed_anchor ?? ''), schedule_pool: [] };
  if (Array.isArray(raw.schedule_pool)) {
    for (const it of raw.schedule_pool) {
      const n = normalizeItem(it);
      if (n) state.schedule_pool.push(n);
    }
  }
  state.schedule_pool.sort((a, b) => a.date.localeCompare(b.date));
  return state;
}

function assignment(item, areaOrder = []) {
  const map = normalizeAssignments(item?.area_assignments);
  const ordered = {};
  for (const area of areaOrder) if (map[area]) ordered[area] = [...map[area]];
  for (const [k, v] of Object.entries(map)) if (!ordered[k]) ordered[k] = [...v];
  if (!Object.keys(ordered).length) {
    const cls = names(item?.classroom_students);
    const cln = names(item?.cleaning_area_students);
    const stu = names(item?.students);
    if (cls.length) ordered['教室'] = cls;
    if (cln.length) ordered['清洁区'] = cln;
    if (!cls.length && !cln.length && stu.length) ordered[areaOrder[0] || '教室'] = stu;
  }
  return ordered;
}

function log(level, msg, payload) {
  const extra = payload === undefined ? '' : `\n${JSON.stringify(payload, null, 2)}`;
  $('log').textContent += `[${now()}] [${level}] ${msg}${extra}\n`;
  const lines = $('log').textContent.split('\n');
  if (lines.length > 350) $('log').textContent = lines.slice(lines.length - 350).join('\n');
  $('log').scrollTop = $('log').scrollHeight;
}

function setStatus(type, text) {
  $('runTag').textContent = type;
  const cls = type === 'ok' ? 'status ok' : type === 'err' ? 'status err' : 'status';
  const dot = type === 'ok' ? 'dot ok' : type === 'err' ? 'dot err' : 'dot warn';
  $('runStatus').className = cls;
  $('runStatus').innerHTML = `<span class="${dot}"></span><span>${html(text)}</span>`;
}

function bridgePost(action, payload) {
  const msg = { source: 'duty-agent-test-page', action, payload: payload || {} };
  if (!hasBridge) { log('WARN', `Bridge 不可用: ${action}`, msg); return false; }
  window.chrome.webview.postMessage(msg);
  log('SEND', `Bridge => ${action}`, msg.payload);
  return true;
}

function setMode(mode) {
  runtimeMode = mode === 'bridge' ? 'bridge' : 'mock';
  $('mode').value = runtimeMode;
  $('runtimeTag').textContent = `runtime: ${runtimeMode}`;
  if (runtimeMode === 'bridge' && hasBridge) {
    $('bridgeDot').className = 'dot ok';
    $('bridgeText').textContent = 'Bridge 已连接';
    bridgePost('ready', { features: ['config', 'roster', 'state', 'run', 'notification'], version: 'test-html-1' });
  } else if (runtimeMode === 'bridge') {
    $('bridgeDot').className = 'dot warn';
    $('bridgeText').textContent = 'Bridge 不可用';
  } else {
    $('bridgeDot').className = 'dot';
    $('bridgeText').textContent = 'Bridge 未启用';
  }
}

function renderOptions(selectId, values) {
  const el = $(selectId);
  el.innerHTML = '';
  for (const v of values) {
    const op = document.createElement('option');
    op.value = v;
    op.textContent = v;
    el.appendChild(op);
  }
  if (el.options.length) el.selectedIndex = 0;
}

function renderConfig() {
  const c = store.config;
  $('cfgPython').value = c.python_path;
  $('cfgApi').value = c.api_key;
  $('cfgBase').value = c.base_url;
  $('cfgModel').value = c.model;
  $('cfgAuto').value = String(c.enable_auto_run);
  $('cfgDay').value = c.auto_run_day;
  $('cfgTime').value = c.auto_run_time;
  $('cfgDays').value = c.auto_run_coverage_days;
  $('cfgPer').value = c.per_day;
  $('cfgRefresh').value = c.component_refresh_time;
  $('cfgSkip').value = String(c.skip_weekends);
  $('cfgStart').value = String(c.start_from_today);
  $('cfgRule').value = c.duty_rule;
  renderOptions('areaList', c.area_names);
  renderOptions('tplList', c.notification_templates);
}

function syncConfigFromForm() {
  store.config = normalizeConfig({
    python_path: $('cfgPython').value,
    api_key: $('cfgApi').value,
    base_url: $('cfgBase').value,
    model: $('cfgModel').value,
    enable_auto_run: $('cfgAuto').value,
    auto_run_day: $('cfgDay').value,
    auto_run_time: $('cfgTime').value,
    auto_run_coverage_days: $('cfgDays').value,
    per_day: $('cfgPer').value,
    skip_weekends: $('cfgSkip').value,
    duty_rule: $('cfgRule').value,
    start_from_today: $('cfgStart').value,
    component_refresh_time: $('cfgRefresh').value,
    area_names: Array.from($('areaList').options).map((x) => x.value),
    notification_templates: Array.from($('tplList').options).map((x) => x.value)
  });
}

function rosterStats() {
  const cnt = new Map();
  const nxt = new Map();
  const td = today();
  const pool = [...store.state.schedule_pool].sort((a, b) => a.date.localeCompare(b.date));

  for (const item of pool) {
    const d = parseIso(item.date);
    if (!d) continue;
    const set = new Set();
    const map = assignment(item, store.config.area_names);
    for (const arr of Object.values(map)) for (const n of arr) if (n) set.add(n);
    for (const n of set) {
      cnt.set(n, (cnt.get(n) || 0) + 1);
      if (d >= td) {
        const old = nxt.get(n);
        if (!old || d < old) nxt.set(n, d);
      }
    }
  }

  const rows = store.roster.map((r) => ({
    id: r.id,
    name: r.name,
    active: r.active,
    next: nxt.get(r.name) ? dateIso(nxt.get(r.name)) : '未安排',
    count: cnt.get(r.name) || 0
  }));

  rows.sort((a, b) => {
    const au = a.next === '未安排';
    const bu = b.next === '未安排';
    if (au !== bu) return au ? 1 : -1;
    if (!au && a.next !== b.next) return a.next.localeCompare(b.next);
    return a.id - b.id;
  });
  return rows;
}

function renderRoster() {
  const rows = rosterStats();
  $('rosterBody').innerHTML = '';
  for (const r of rows) {
    const tr = document.createElement('tr');
    tr.dataset.id = String(r.id);
    if (r.id === selectedRosterId) tr.className = 'sel';
    tr.innerHTML = `<td class="mono">${r.id}</td><td>${html(r.name)}</td><td class="mono">${html(r.next)}</td><td class="mono">${r.count}</td><td>${r.active ? 'true' : 'false'}</td>`;
    tr.addEventListener('click', () => { selectedRosterId = r.id; renderRoster(); });
    $('rosterBody').appendChild(tr);
  }
}

function allAreaNames() {
  const out = [...store.config.area_names];
  const set = new Set(out);
  for (const item of store.state.schedule_pool) {
    for (const k of Object.keys(assignment(item, out))) {
      if (!set.has(k)) { set.add(k); out.push(k); }
    }
  }
  return out;
}
function renderSchedule() {
  const areas = allAreaNames();
  $('scheduleHead').innerHTML = `<tr><th>日期</th><th>星期</th>${areas.map((a) => `<th>${html(a)}</th>`).join('')}</tr>`;
  const pool = [...store.state.schedule_pool].sort((a, b) => a.date.localeCompare(b.date));
  if (!pool.length) {
    $('scheduleBody').innerHTML = `<tr><td colspan="${2 + areas.length}">暂无排班数据</td></tr>`;
    return;
  }
  $('scheduleBody').innerHTML = '';
  for (const it of pool) {
    const map = assignment(it, areas);
    const tr = document.createElement('tr');
    const cells = [`<td class="mono">${html(it.date)}</td>`, `<td class="mono">${html(it.day)}</td>`];
    for (const a of areas) cells.push(`<td>${html((map[a] || []).join(', ') || '-')}</td>`);
    tr.innerHTML = cells.join('');
    $('scheduleBody').appendChild(tr);
  }
}

function renderLegacy() {
  const pool = [...store.state.schedule_pool].sort((a, b) => a.date.localeCompare(b.date));
  $('legacyBody').innerHTML = '';
  if (!pool.length) {
    $('legacyBody').innerHTML = '<tr><td colspan="3">暂无排班数据</td></tr>';
    return;
  }
  for (const it of pool) {
    const map = assignment(it, store.config.area_names);
    const c1 = map['教室'] || names(it.classroom_students);
    const c2 = map['清洁区'] || names(it.cleaning_area_students);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="mono">${html(it.date)}</td><td>${html(c1.join(', ') || '-')}</td><td>${html(c2.join(', ') || '-')}</td>`;
    $('legacyBody').appendChild(tr);
  }
}

function renderAll() {
  renderConfig();
  renderRoster();
  renderSchedule();
  renderLegacy();
  $('runtimeTag').textContent = `runtime: ${runtimeMode}`;
}

function startDateFromConfig() {
  if (store.config.start_from_today) return today();
  const pool = [...store.state.schedule_pool].sort((a, b) => a.date.localeCompare(b.date));
  if (pool.length) {
    const last = parseIso(pool[pool.length - 1].date);
    if (last) return addDays(last, 1);
  }
  return addDays(today(), 1);
}

function targetDates(start, days, skipWeekends) {
  const out = [];
  let d = new Date(start);
  while (out.length < days) {
    const w = d.getDay();
    if (!(skipWeekends && (w === 0 || w === 6))) out.push(new Date(d));
    d = addDays(d, 1);
  }
  return out;
}

function lastAssignedName(pool, areas, applyMode, startDate) {
  const start = dateIso(startDate);
  const src = applyMode === 'append' ? pool : pool.filter((x) => x.date < start);
  for (let i = src.length - 1; i >= 0; i--) {
    const map = assignment(src[i], areas);
    const keys = [...areas, ...Object.keys(map).filter((k) => !areas.includes(k))];
    for (const k of keys) {
      const arr = map[k] || [];
      if (arr.length) return arr[arr.length - 1];
    }
  }
  return null;
}

function mergeSchedule(existing, generated, applyMode, startDate) {
  const cur = [...existing].sort((a, b) => a.date.localeCompare(b.date));
  const start = dateIso(startDate);
  const td = dateIso(today());
  if (applyMode === 'replace_all') return [...generated];
  if (applyMode === 'replace_future') return [...cur.filter((x) => x.date <= td), ...generated].sort((a, b) => a.date.localeCompare(b.date));
  if (applyMode === 'replace_overlap') {
    const end = generated.length ? generated[generated.length - 1].date : start;
    return [...cur.filter((x) => x.date < start || x.date > end), ...generated].sort((a, b) => a.date.localeCompare(b.date));
  }
  return [...cur, ...generated];
}

function runMock() {
  syncConfigFromForm();
  const instruction = $('instruction').value.trim();
  const applyMode = $('applyMode').value;
  if (!instruction) { setStatus('err', '请输入排班指令。'); return; }

  const areas = list(store.config.area_names, DEFAULT_CONFIG.area_names);
  const per = clamp(int(store.config.per_day, 2), 1, 30);
  const days = clamp(int(store.config.auto_run_coverage_days, 5), 1, 30);
  const active = store.roster.filter((r) => r.active && r.name).sort((a, b) => a.id - b.id);
  if (!active.length) { setStatus('err', '没有可排班的 active 学生。'); return; }

  const start = startDateFromConfig();
  const dates = targetDates(start, days, store.config.skip_weekends);
  const anchor = lastAssignedName(store.state.schedule_pool, areas, applyMode, start);
  let idx = active.length - 1;
  if (anchor) {
    const p = active.findIndex((x) => x.name === anchor);
    if (p >= 0) idx = p;
  }
  let cursor = (idx + 1) % active.length;

  const generated = [];
  for (const d of dates) {
    const used = new Set();
    const map = {};
    for (const area of areas) {
      const arr = [];
      const noDupAcrossArea = areas.length * per <= active.length;
      let guard = 0;
      while (arr.length < per && guard < active.length * 4) {
        const stu = active[cursor];
        cursor = (cursor + 1) % active.length;
        guard++;
        if (!stu || arr.includes(stu.name)) continue;
        if (noDupAcrossArea && used.has(stu.name)) continue;
        arr.push(stu.name);
        used.add(stu.name);
      }
      while (arr.length < per) {
        const stu = active[cursor];
        cursor = (cursor + 1) % active.length;
        if (!stu || arr.includes(stu.name)) break;
        arr.push(stu.name);
      }
      map[area] = arr;
    }

    const a1 = areas[0];
    const a2 = areas.length > 1 ? areas[1] : a1;
    generated.push({
      date: dateIso(d),
      day: DAY[d.getDay()],
      students: map[a1] ? [...map[a1]] : [],
      classroom_students: map[a1] ? [...map[a1]] : [],
      cleaning_area_students: map[a2] ? [...map[a2]] : [],
      area_assignments: map
    });
  }

  store.state.schedule_pool = mergeSchedule(store.state.schedule_pool, generated, applyMode, start);
  store.state = normalizeState(store.state);
  renderAll();
  setStatus('ok', `Mock 排班成功，生成 ${generated.length} 天。`);
  log('OK', 'Mock 排班成功。', { generated_days: generated.length, apply_mode: applyMode });

  notifyByTemplates('manual', true, $('runDetail').value.trim() || 'mock run success', instruction, applyMode, clamp(int($('nDuration').value, 7), 1, 30), false);
}

function renderTpl(tpl, tokens) {
  return String(tpl || '').replace(/\{([a-zA-Z0-9_]+)\}/g, (_, k) => (k in tokens ? tokens[k] : `{${k}}`)).trim();
}

function notifyByTemplates(scene, success, detail, instruction, applyMode, duration, sendHost) {
  syncConfigFromForm();
  const sceneText = scene === 'auto' ? '自动排班' : '手动排班';
  const statusText = success ? '成功' : '失败';
  const tok = {
    scene: sceneText,
    status: statusText,
    date: `${dateIso(today())} ${new Date().toTimeString().slice(0, 5)}`,
    areas: list(store.config.area_names, DEFAULT_CONFIG.area_names).join('、'),
    days: String(store.config.auto_run_coverage_days),
    per_day: String(store.config.per_day),
    mode: applyMode || $('applyMode').value,
    instruction: String(instruction || '').trim().slice(0, 80),
    message: String(detail || '').trim().slice(0, 100)
  };

  const seen = new Set();
  const msgs = [];
  for (const tpl of list(store.config.notification_templates, DEFAULT_CONFIG.notification_templates)) {
    const txt = renderTpl(tpl, tok);
    if (!txt || seen.has(txt)) continue;
    seen.add(txt);
    msgs.push(txt);
  }
  if (!msgs.length) msgs.push(`${sceneText}${statusText}，日期：${tok.date}`);

  $('noticeList').innerHTML = '';
  for (const m of msgs) {
    const div = document.createElement('div');
    div.className = `notice ${success ? '' : 'fail'}`.trim();
    div.textContent = m;
    $('noticeList').appendChild(div);
    if (sendHost && runtimeMode === 'bridge') {
      bridgePost('publish_notification', { text: m, duration_seconds: duration });
    }
  }

  log('INFO', `通知模板渲染完成 (${msgs.length} 条)。`, { scene, success, tokens: tok });
}

function runBridge() {
  syncConfigFromForm();
  const instruction = $('instruction').value.trim();
  const applyMode = $('applyMode').value;
  if (!instruction) { setStatus('err', '请输入排班指令。'); return; }
  const ok = bridgePost('run_core', { instruction, apply_mode: applyMode, config: store.config });
  setStatus(ok ? 'warn' : 'err', ok ? '已发送 run_core 到宿主。' : 'Bridge 不可用，无法发送 run_core。');
}

function addArea() {
  const name = $('newArea').value.trim();
  if (!name) { setStatus('err', '区域名不能为空。'); return; }
  syncConfigFromForm();
  if (store.config.area_names.includes(name)) { setStatus('err', '区域已存在。'); return; }
  store.config.area_names.push(name);
  $('newArea').value = '';
  renderConfig();
  renderSchedule();
  setStatus('ok', `已新增区域: ${name}`);
}

function delArea() {
  syncConfigFromForm();
  const v = $('areaList').value;
  if (!v) { setStatus('err', '请先选择区域。'); return; }
  if (store.config.area_names.length <= 1) { setStatus('err', '至少保留一个区域。'); return; }
  store.config.area_names = store.config.area_names.filter((x) => x !== v);
  renderConfig();
  renderSchedule();
  setStatus('ok', `已删除区域: ${v}`);
}

function addTpl() {
  const text = $('newTpl').value.trim();
  if (!text) { setStatus('err', '模板不能为空。'); return; }
  syncConfigFromForm();
  if (store.config.notification_templates.includes(text)) { setStatus('err', '模板已存在。'); return; }
  store.config.notification_templates.push(text);
  $('newTpl').value = '';
  renderConfig();
  setStatus('ok', '通知模板已新增。');
}

function delTpl() {
  syncConfigFromForm();
  const v = $('tplList').value;
  if (!v) { setStatus('err', '请先选择模板。'); return; }
  if (store.config.notification_templates.length <= 1) { setStatus('err', '至少保留一个模板。'); return; }
  store.config.notification_templates = store.config.notification_templates.filter((x) => x !== v);
  renderConfig();
  setStatus('ok', '通知模板已删除。');
}

function addStudent() {
  const name = $('newStudent').value.trim();
  if (!name) { setStatus('err', '学生姓名不能为空。'); return; }
  const nextId = store.roster.length ? Math.max(...store.roster.map((x) => x.id)) + 1 : 1;
  store.roster.push({ id: nextId, name, active: true });
  $('newStudent').value = '';
  selectedRosterId = nextId;
  renderRoster();
  setStatus('ok', `已添加学生: ${name} (ID ${nextId})`);
}

function delStudent() {
  if (selectedRosterId == null) { setStatus('err', '请先在表格中选择学生。'); return; }
  const before = store.roster.length;
  store.roster = store.roster.filter((x) => x.id !== selectedRosterId);
  if (store.roster.length === before) { setStatus('err', '未找到选中学生。'); return; }
  selectedRosterId = null;
  renderRoster();
  setStatus('ok', '已删除选中学生。');
}

function exportSnapshot() {
  syncConfigFromForm();
  const out = clone(store);
  if (out.config.api_key && String(out.config.api_key).trim()) out.config.api_key = API_KEY_MASK;
  $('snapshot').value = JSON.stringify(out, null, 2);
  log('INFO', '快照已导出（API Key 已掩码）。');
}

function importSnapshot() {
  const txt = $('snapshot').value.trim();
  if (!txt) { setStatus('err', '请先粘贴快照 JSON。'); return; }
  try {
    const parsed = JSON.parse(txt);
    const oldKey = store.config.api_key;
    const cfg = normalizeConfig(parsed.config);
    if (cfg.api_key === API_KEY_MASK) cfg.api_key = oldKey;
    store = {
      config: cfg,
      roster: normalizeRoster(parsed.roster),
      state: normalizeState(parsed.state)
    };
    selectedRosterId = null;
    renderAll();
    setStatus('ok', '快照导入成功。');
  } catch (e) {
    setStatus('err', `快照导入失败: ${e instanceof Error ? e.message : String(e)}`);
  }
}

function resetAll() {
  store = {
    config: normalizeConfig(DEFAULT_CONFIG),
    roster: normalizeRoster(DEFAULT_ROSTER),
    state: normalizeState(DEFAULT_STATE)
  };
  selectedRosterId = null;
  $('snapshot').value = '';
  $('instruction').value = '';
  $('runDetail').value = '';
  $('nMsg').value = '';
  $('noticeList').innerHTML = '';
  renderAll();
  setStatus('ok', '已重置为默认测试数据。');
}

function applyHost(data) {
  if (!data || typeof data !== 'object') return;
  let changed = false;
  if ('config' in data) { store.config = normalizeConfig(data.config); changed = true; }
  if ('roster' in data) { store.roster = normalizeRoster(data.roster); changed = true; }
  if ('state' in data) { store.state = normalizeState(data.state); changed = true; }
  if (data.type === 'run_result') {
    const ok = !!data.success;
    setStatus(ok ? 'ok' : 'err', ok ? '宿主 run_core 成功。' : `宿主 run_core 失败: ${data.message || 'unknown'}`);
    if (data.message) $('nMsg').value = String(data.message);
  }
  if (changed) {
    selectedRosterId = null;
    renderAll();
  }
}

function bind() {
  $('mode').addEventListener('change', () => setMode($('mode').value));
  $('runBtn').addEventListener('click', () => runtimeMode === 'bridge' ? runBridge() : runMock());
  $('loadBtn').addEventListener('click', () => {
    if (runtimeMode === 'bridge') {
      const ok = bridgePost('load_all', {});
      setStatus(ok ? 'warn' : 'err', ok ? '已请求宿主加载数据。' : 'Bridge 不可用，无法加载。');
    } else {
      renderAll();
      setStatus('ok', 'Mock 数据已刷新。');
    }
  });
  $('saveCfgBtn').addEventListener('click', () => {
    syncConfigFromForm();
    if (runtimeMode === 'bridge') {
      const ok = bridgePost('save_config', { config: store.config });
      setStatus(ok ? 'warn' : 'err', ok ? '配置已发送到宿主。' : 'Bridge 不可用，无法保存配置。');
    } else {
      setStatus('ok', 'Mock 配置已保存到内存。');
      log('OK', 'Mock 保存配置。', store.config);
    }
  });
  $('saveRosterBtn').addEventListener('click', () => {
    if (runtimeMode === 'bridge') {
      const ok = bridgePost('save_roster', { roster: store.roster });
      setStatus(ok ? 'warn' : 'err', ok ? '名单已发送到宿主。' : 'Bridge 不可用，无法保存名单。');
    } else {
      setStatus('ok', 'Mock 名单已保存到内存。');
      log('OK', 'Mock 保存名单。', store.roster);
    }
  });

  $('addArea').addEventListener('click', addArea);
  $('delArea').addEventListener('click', delArea);
  $('addTpl').addEventListener('click', addTpl);
  $('delTpl').addEventListener('click', delTpl);
  $('addStudent').addEventListener('click', addStudent);
  $('delStudent').addEventListener('click', delStudent);

  $('previewNotice').addEventListener('click', () => {
    notifyByTemplates($('nScene').value, $('nStatus').value === 'success', $('nMsg').value.trim(), $('instruction').value.trim(), $('applyMode').value, clamp(int($('nDuration').value, 7), 1, 30), false);
    setStatus('ok', '通知模板预览已更新。');
  });

  $('sendNotice').addEventListener('click', () => {
    notifyByTemplates($('nScene').value, $('nStatus').value === 'success', $('nMsg').value.trim(), $('instruction').value.trim(), $('applyMode').value, clamp(int($('nDuration').value, 7), 1, 30), true);
    if (runtimeMode === 'bridge' && hasBridge) setStatus('warn', '通知已发送到宿主。');
    else setStatus('ok', 'Bridge 不可用，仅本地预览。');
  });

  $('exportBtn').addEventListener('click', exportSnapshot);
  $('importBtn').addEventListener('click', importSnapshot);
  $('resetBtn').addEventListener('click', resetAll);

  if (hasBridge) {
    window.chrome.webview.addEventListener('message', (event) => {
      log('RECV', 'Bridge <= message', event.data);
      applyHost(event.data);
    });
  }
}

bind();
setMode('mock');
renderAll();
setStatus('warn', '测试控制台已就绪。');
log('INFO', '页面初始化完成。');
</script>
</body>
</html>

