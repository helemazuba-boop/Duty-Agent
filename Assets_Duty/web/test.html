<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Duty-Agent 测试控制台</title>
  <style>
    :root {
      --bg1: rgba(248, 251, 255, 0.55);
      --bg2: rgba(239, 246, 255, 0.45);
      --card: rgba(255, 255, 255, 0.82);
      --line: rgba(148, 163, 184, 0.35);
      --text: #1f2937;
      --muted: #64748b;
      --brand: #0f766e;
      --warn: #d97706;
      --danger: #b91c1c;
      --ok: #0f766e;
      --input-bg: rgba(255, 255, 255, 0.72);
      --table-head: rgba(248, 250, 252, 0.80);
      --radius: 14px;
      --shadow: 0 12px 28px rgba(15, 23, 42, .08);
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      min-height: 100%;
      background: #f6f9ff;
    }

    body {
      font-family: "Noto Sans SC", "Microsoft YaHei UI", "Segoe UI", sans-serif;
      color: var(--text);
      background: linear-gradient(145deg, var(--bg1), var(--bg2));
      padding: 18px;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity .24s ease, transform .24s ease;
    }

    body.page-ready {
      opacity: 1;
      transform: translateY(0);
    }

    .shell {
      max-width: 1500px;
      margin: 0 auto;
    }

    .topbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 16px;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: var(--card);
      box-shadow: var(--shadow);
      margin-bottom: 12px;
    }

    .topbar h1 {
      margin: 0;
      font-size: 23px;
    }

    .topbar p {
      margin: 3px 0 0;
      color: var(--muted);
      font-size: 12px;
    }

    .mode {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chip {
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 6px 10px;
      background: var(--card);
      font-size: 12px;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #9ca3af;
    }

    .dot.ok {
      background: var(--ok);
    }

    .dot.warn {
      background: var(--warn);
    }

    .dot.err {
      background: var(--danger);
    }

    .pill {
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      color: var(--muted);
      background: var(--card);
    }

    .mono {
      font-family: "Consolas", "JetBrains Mono", "Courier New", monospace;
    }

    .grid {
      display: grid;
      grid-template-columns: 1.1fr 1.2fr 1.4fr;
      gap: 12px;
    }

    .col {
      display: grid;
      gap: 12px;
      align-content: start;
    }

    .card {
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: var(--card);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      background: var(--card);
    }

    .head h2 {
      margin: 0;
      font-size: 14px;
    }

    .body {
      padding: 11px 12px;
      display: grid;
      gap: 9px;
    }

    .row {
      display: grid;
      gap: 6px;
    }

    .two {
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .three {
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
    }

    label {
      font-size: 12px;
      color: var(--muted);
    }

    input,
    select,
    textarea,
    button {
      font: inherit;
      font-size: 13px;
    }

    input,
    select,
    textarea {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: var(--input-bg);
      color: var(--text);
      padding: 8px 9px;
      outline: none;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(15, 118, 110, .14);
    }

    textarea {
      min-height: 84px;
      resize: vertical;
    }

    button {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px 10px;
      background: var(--input-bg);
      color: var(--text);
      cursor: pointer;
    }

    button:disabled {
      opacity: .6;
      cursor: not-allowed;
    }

    button.primary {
      background: linear-gradient(135deg, #0f766e, #115e59);
      color: #fff;
      border-color: transparent;
    }

    button.warn {
      background: linear-gradient(135deg, #d97706, #b45309);
      color: #fff;
      border-color: transparent;
    }

    button.danger {
      background: linear-gradient(135deg, #dc2626, #991b1b);
      color: #fff;
      border-color: transparent;
    }

    button.ghost {
      background: transparent;
    }

    .btns {
      display: flex;
      flex-wrap: wrap;
      gap: 7px;
    }

    .hint {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
      background: var(--card);
      border: 1px dashed var(--line);
      border-radius: 10px;
      padding: 7px 8px;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 7px 8px;
      background: var(--card);
    }

    .status.slim {
      font-size: 11px;
      padding: 6px 8px;
    }

    .status.ok {
      border-color: rgba(15, 118, 110, .35);
    }

    .status.err {
      border-color: rgba(185, 28, 28, .35);
    }

    .list select {
      min-height: 86px;
    }

    .table-wrap {
      overflow: auto;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: var(--card);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 420px;
    }

    th,
    td {
      border-bottom: 1px solid #edf1f5;
      text-align: left;
      font-size: 12px;
      padding: 8px 9px;
      vertical-align: top;
    }

    th {
      background: var(--table-head);
      color: var(--muted);
      position: sticky;
      top: 0;
    }

    tr.sel {
      background: rgba(15, 118, 110, .12);
    }

    #noticeList {
      display: grid;
      gap: 7px;
      max-height: 160px;
      overflow: auto;
    }

    .notice {
      border: 1px solid var(--line);
      border-left: 4px solid var(--brand);
      border-radius: 10px;
      padding: 7px 8px;
      background: var(--card);
      font-size: 12px;
    }

    .notice.fail {
      border-left-color: var(--danger);
    }

    #snapshot {
      min-height: 170px;
      font-size: 12px;
    }

    input[type="checkbox"] {
      width: 16px;
      height: 16px;
      padding: 0;
      accent-color: var(--brand);
    }

    .active-cell {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .kbd {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 18px;
      height: 18px;
      padding: 0 5px;
      border-radius: 6px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.9);
      font-size: 11px;
      color: var(--muted);
      line-height: 1;
    }

    #log {
      min-height: 140px;
      max-height: 300px;
      overflow: auto;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: var(--card);
      color: var(--text);
      padding: 9px;
      font-size: 12px;
      line-height: 1.45;
      white-space: pre-wrap;
    }

    @media (prefers-reduced-motion: reduce) {
      body {
        opacity: 1;
        transform: none;
        transition: none;
      }
    }

    @media (max-width: 1200px) {
      .grid {
        grid-template-columns: 1fr;
      }

      .two,
      .three {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="shell">
    <section class="topbar">
      <div>
        <h1>Duty-Agent 测试控制台</h1>
        <p>覆盖配置、多区域、名单、通知模板、排班执行、组件固定视图与快照回归。配置与名单默认自动应用。</p>
      </div>
      <div class="mode">
        <label for="mode">模式</label>
        <select id="mode" style="width:170px">
          <option value="mock">本地模拟</option>
          <option value="bridge">宿主模式（网页容器）</option>
        </select>
        <span class="chip"><span id="bridgeDot" class="dot"></span><span id="bridgeText">宿主未启用</span></span>
        <span id="runtimeTag" class="pill mono">运行模式：本地模拟</span>
        <span id="previewUrlTag" class="pill mono">本地调试URL：-</span>
        <span id="apiOverwriteUrlTag" class="pill mono">覆盖排班API：-</span>
      </div>
    </section>

    <div class="grid">
      <div class="col">
        <section class="card">
          <div class="head">
            <h2>运行与同步</h2><span id="runTag" class="pill mono">待命</span>
          </div>
          <div class="body">
            <div class="row">
              <label for="instruction">排班指令</label>
              <textarea id="instruction" placeholder="例如：从今天开始排5天，每个区域每天2人，张三本周请假。"></textarea>
            </div>
            <div class="row two">
              <div class="row">
                <label for="applyMode">应用模式</label>
                <select id="applyMode">
                  <option value="append">追加</option>
                  <option value="replace_future">替换未来</option>
                  <option value="replace_overlap">替换重叠区间</option>
                  <option value="replace_all">全部替换</option>
                </select>
              </div>
              <div class="row">
                <label for="runDetail">运行详情(通知附加)</label>
                <input id="runDetail" type="text" placeholder="例如：模拟执行成功">
              </div>
            </div>
            <div class="btns">
              <button id="runBtn" class="primary">执行排班</button>
              <button id="loadBtn">加载数据</button>
            </div>
            <div id="autoApplyStatus" class="status ok slim"><span class="dot ok"></span><span>自动应用已启用：输入后按 Enter
                或切出输入框即可生效。</span></div>
            <div class="row">
              <label for="apiInstruction">本地接口覆盖排班指令（可留空复用上方排班指令）</label>
              <textarea id="apiInstruction" placeholder="例如：从今天开始覆盖排7天，每个区域每天2人。"></textarea>
            </div>
            <div class="row two">
              <div class="row">
                <label for="apiBaseUrl">API 基址（自动填充）</label>
                <input id="apiBaseUrl" type="text" placeholder="http://127.0.0.1:48380">
              </div>
              <div class="row">
                <label for="apiStatus">接口状态</label>
                <input id="apiStatus" type="text" value="待命" readonly>
              </div>
            </div>
            <div class="btns">
              <button id="apiOverwriteBtn">通过本地接口覆盖排班</button>
            </div>
            <div class="row">
              <label for="apiResponse">接口响应</label>
              <textarea id="apiResponse" class="mono"
                placeholder="这里显示 /api/v1/schedule/overwrite 的 JSON 响应"></textarea>
            </div>
            <div id="runStatus" class="status"><span class="dot warn"></span><span>等待操作</span></div>
            <div class="hint">快捷键：<span class="kbd">Ctrl</span> + <span class="kbd">Enter</span> 执行排班；输入框按 <span
                class="kbd">Enter</span> 自动应用，文本域用 <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span>
              或失焦应用。导出快照会把接口密钥掩码为 <span class="mono">***仅运行时***</span>。</div>
          </div>
        </section>

        <section class="card">
          <div class="head">
            <h2>区域与通知模板</h2><span class="pill">配置列表</span>
          </div>
          <div class="body">
            <div class="row two">
              <div class="row list">
                <label>清洁区域</label>
                <select id="areaList" size="6"></select>
                <div class="btns">
                  <input id="newArea" type="text" placeholder="新增区域名">
                  <button id="addArea">新增</button>
                  <button id="delArea" class="danger">删除</button>
                </div>
              </div>
              <div class="row list">
                <label>通知模板</label>
                <select id="tplList" size="6"></select>
                <div class="btns">
                  <input id="newTpl" type="text" placeholder="{scene}{status}...">
                  <button id="addTpl">新增</button>
                  <button id="delTpl" class="danger">删除</button>
                </div>
              </div>
            </div>
            <div class="hint">占位符：<span class="mono">{scene} {status} {date} {areas} {days} {per_day} {mode}
                {instruction} {message}</span></div>
          </div>
        </section>

        <section class="card">
          <div class="head">
            <h2>通知预览与触发</h2><span class="pill">通知</span>
          </div>
          <div class="body">
            <div class="row three">
              <div class="row">
                <label for="nScene">场景</label>
                <select id="nScene">
                  <option value="manual">手动</option>
                  <option value="auto">自动</option>
                </select>
              </div>
              <div class="row">
                <label for="nStatus">状态</label>
                <select id="nStatus">
                  <option value="success">成功</option>
                  <option value="fail">失败</option>
                </select>
              </div>
              <div class="row">
                <label for="nDuration">持续秒数</label>
                <input id="nDuration" type="number" min="1" max="30" value="7">
              </div>
            </div>
            <div class="row"><label for="nMsg">消息</label><input id="nMsg" type="text" placeholder="例如：API Key 缺失"></div>
            <div class="btns">
              <button id="previewNotice">本地预览</button>
              <button id="sendNotice" class="warn">发送到宿主</button>
              <button id="triggerRunCompletionNotice">触发完成排班通知</button>
              <button id="triggerDutyReminderNotice">触发值日提醒通知</button>
              <button id="openInBrowserBtn">浏览器打开 test.html</button>
            </div>
            <div id="noticeList"></div>
          </div>
        </section>
      </div>

      <div class="col">
        <section class="card">
          <div class="head">
            <h2>AI 长期规则</h2><span class="pill">发送给 AI</span>
          </div>
          <div class="body">
            <div class="hint">以下内容会作为固定规则发送给 AI，每次排班都会生效。可包含排班逻辑、区域分配偏好、特殊安排等。</div>
            <div class="row"><label for="cfgRule">长期排班规则</label><textarea id="cfgRule"
                placeholder="示例长期规则（可直接修改使用）：&#10;每天排班2人，跳过周末&#10;区域：教室、清洁区&#10;教室每天2人，清洁区每天3人&#10;排班周期：5天&#10;男生优先排清洁区"
                style="min-height:120px"></textarea></div>
          </div>
        </section>

        <section class="card">
          <div class="head">
            <h2>核心配置</h2><span class="pill">配置</span>
          </div>
          <div class="body">
            <div class="row"><label for="cfgApi">接口密钥（运行时）</label><input id="cfgApi" type="password"></div>
            <div class="row two">
              <div class="row"><label for="cfgBase">基础地址</label><input id="cfgBase" type="text"></div>
              <div class="row"><label for="cfgModel">模型</label><input id="cfgModel" type="text"></div>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="head">
            <h2>排班处理参数</h2><span class="pill">运行时</span>
          </div>
          <div class="body">
            <div class="hint">以下参数控制排班的运行时处理逻辑（日期生成、结果归一化等），不会直接发送给 AI。</div>
            <div class="row three">
              <div class="row"><label for="cfgAuto">自动排班</label><select id="cfgAuto">
                  <option value="true">启用</option>
                  <option value="false">禁用</option>
                </select></div>
              <div class="row"><label for="cfgDay">自动排班日</label><select id="cfgDay">
                  <option value="Monday">周一</option>
                  <option value="Tuesday">周二</option>
                  <option value="Wednesday">周三</option>
                  <option value="Thursday">周四</option>
                  <option value="Friday">周五</option>
                  <option value="Saturday">周六</option>
                  <option value="Sunday">周日</option>
                </select></div>
              <div class="row"><label for="cfgTime">自动排班时间</label><input id="cfgTime" type="time" step="60"></div>
            </div>
            <div class="row three">
              <div class="row"><label for="cfgDays">生成天数</label><input id="cfgDays" type="number" min="1" max="30">
              </div>
              <div class="row"><label for="cfgPer">默认每区域每日人数</label><input id="cfgPer" type="number" min="1" max="30">
              </div>
              <div class="row"><label for="cfgRefresh">组件刷新时间</label><input id="cfgRefresh" type="time" step="60"></div>
            </div>
            <div class="row two">
              <div class="row">
                <label for="cfgSkip">跳过周末排班</label>
                <select id="cfgSkip">
                  <option value="true">是</option>
                  <option value="false">否</option>
                </select>
              </div>
              <div class="row">
                <label for="cfgEnableMcp">启用本地 MCP 接口</label>
                <select id="cfgEnableMcp">
                  <option value="false">禁用</option>
                  <option value="true">启用</option>
                </select>
              </div>
            </div>
            <div class="row"><label for="cfgAreaCounts">区域单独人数（每行"区域=人数"）</label><textarea id="cfgAreaCounts"
                class="mono" placeholder="教室=2&#10;清洁区=3"></textarea></div>
          </div>
        </section>

        <section class="card">
          <div class="head">
            <h2>名单管理(排序视图)</h2><span class="pill">名单</span>
          </div>
          <div class="body">
            <div class="btns">
              <input id="newStudent" type="text" placeholder="学生姓名">
              <button id="addStudent">添加并自动分配ID</button>
              <button id="delStudent" class="danger">删除选中</button>
            </div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>姓名</th>
                    <th>下一次值日</th>
                    <th>总值日次数</th>
                    <th>启用状态</th>
                  </tr>
                </thead>
                <tbody id="rosterBody"></tbody>
              </table>
            </div>
            <div class="hint">排序规则：下一次值日最早在前，未安排排最后。勾选“启用状态”会立即生效并同步。</div>
          </div>
        </section>
      </div>

      <div class="col">
        <section class="card">
          <div class="head">
            <h2>排班预览(动态区域)</h2><span class="pill">排班池</span>
          </div>
          <div class="body">
            <div class="table-wrap">
              <table>
                <thead id="scheduleHead"></thead>
                <tbody id="scheduleBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="head">
            <h2>组件固定视图预览</h2><span class="pill">教室 / 清洁区</span>
          </div>
          <div class="body">
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>日期</th>
                    <th>教室</th>
                    <th>清洁区</th>
                  </tr>
                </thead>
                <tbody id="legacyBody"></tbody>
              </table>
            </div>
            <div class="hint">用于验证“组件页仍保持固定双区域”的显示行为。</div>
          </div>
        </section>

        <section class="card">
          <div class="head">
            <h2>快照与日志</h2><span class="pill">导入导出</span>
          </div>
          <div class="body">
            <div class="btns">
              <button id="exportBtn">导出快照(JSON)</button>
              <button id="importBtn">导入快照(JSON)</button>
              <button id="resetBtn" class="ghost">重置默认</button>
              <button id="clearLogBtn" class="ghost">清空日志</button>
              <button id="errorLogBtn" class="ghost">仅错误日志：关闭</button>
            </div>
            <textarea id="snapshot" class="mono" placeholder="导入或查看快照 JSON"></textarea>
            <div id="log" class="mono"></div>
            <div class="hint">宿主消息 action：<span class="mono">ready / load_all / save_config(自动) / save_roster(自动) /
                run_core / publish_notification / trigger_run_completion_notification /
                trigger_duty_reminder_notification / open_test_in_browser</span></div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
    'use strict';
    const DEFAULT_CONFIG = {
      python_path: '.\\Assets_Duty\\python-embed\\python.exe',
      api_key: '',
      base_url: 'https://integrate.api.nvidia.com/v1',
      model: 'moonshotai/kimi-k2-thinking',
      enable_auto_run: false,
      enable_mcp: false,
      auto_run_day: 'Monday',
      auto_run_time: '08:00',
      auto_run_coverage_days: 5,
      per_day: 2,
      skip_weekends: true,
      duty_rule: '',
      component_refresh_time: '08:00',
      area_names: ['教室', '清洁区'],
      area_per_day_counts: { '教室': 2, '清洁区': 2 },
      notification_templates: ['{scene}{status}，日期：{date}，区域：{areas}'],
      start_from_today: false
    };

    const DEFAULT_ROSTER = [
      { id: 101, name: '张三', active: true },
      { id: 102, name: '李四', active: true },
      { id: 103, name: '王五', active: true },
      { id: 104, name: '赵六', active: true },
      { id: 105, name: '孙七', active: false },
      { id: 106, name: '周八', active: true }
    ];

    const DEFAULT_STATE = { seed_anchor: '', schedule_pool: [] };
    const DAY = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
    const API_KEY_MASK = '***仅运行时***';
    const LEGACY_API_KEY_MASK = '***runtime-only***';
    const HOST_API_KEY_MASK = '********';
    const hasBridge = !!(window.chrome && window.chrome.webview);

    let runtimeMode = 'mock';
    let selectedRosterId = null;
    let logFilter = 'all';
    let runInProgress = false;
    let localPreviewUrl = '';
    let apiOverwriteUrl = '';
    const logEntries = [];
    const LOG_MAX = 500;
    const LOG_LEVEL_LABELS = {
      INFO: '信息',
      WARN: '警告',
      ERROR: '错误',
      SEND: '发送',
      RECV: '接收',
      OK: '成功'
    };
    let store = {
      config: normalizeConfig(DEFAULT_CONFIG),
      roster: normalizeRoster(DEFAULT_ROSTER),
      state: normalizeState(DEFAULT_STATE)
    };

    const $ = (id) => document.getElementById(id);

    function clone(v) { return JSON.parse(JSON.stringify(v)); }
    function int(v, d) { const n = Number(v); return Number.isFinite(n) ? Math.trunc(n) : d; }
    function bool(v, d) {
      if (typeof v === 'boolean') return v;
      if (typeof v === 'string') {
        const s = v.trim().toLowerCase();
        if (['true', '1', 'yes', 'on'].includes(s)) return true;
        if (['false', '0', 'no', 'off'].includes(s)) return false;
      }
      return d;
    }
    function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }
    function now() {
      const d = new Date();
      return `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}:${String(d.getSeconds()).padStart(2, '0')}`;
    }
    function today() { const d = new Date(); d.setHours(0, 0, 0, 0); return d; }
    function addDays(date, n) { const d = new Date(date); d.setDate(d.getDate() + n); d.setHours(0, 0, 0, 0); return d; }
    function dateIso(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }
    function parseIso(s) {
      if (typeof s !== 'string' || !/^\d{4}-\d{2}-\d{2}$/.test(s)) return null;
      const [y, m, d] = s.split('-').map(Number);
      const dt = new Date(y, m - 1, d);
      dt.setHours(0, 0, 0, 0);
      return (dt.getFullYear() === y && dt.getMonth() === m - 1 && dt.getDate() === d) ? dt : null;
    }
    function html(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }
    function list(input, fallback) {
      const seen = new Set();
      const out = [];
      if (Array.isArray(input)) {
        for (const raw of input) {
          const t = String(raw ?? '').trim();
          if (!t || seen.has(t)) continue;
          seen.add(t);
          out.push(t);
        }
      }
      return out.length ? out : clone(fallback);
    }
    function names(v) { return list(v, []); }
    function parseAreaCountsText(raw) {
      const out = {};
      for (const lineRaw of String(raw ?? '').split(/\r?\n/g)) {
        const line = lineRaw.trim();
        if (!line) continue;
        const idx = line.search(/[=:：]/);
        const area = (idx >= 0 ? line.slice(0, idx) : line).trim();
        const countText = (idx >= 0 ? line.slice(idx + 1) : '').trim();
        const n = Number(countText);
        if (!area || !Number.isFinite(n)) continue;
        out[area] = clamp(Math.trunc(n), 1, 30);
      }
      return out;
    }
    function normalizeAreaCounts(areaNames, sourceCounts, fallbackPerDay) {
      const out = {};
      const source = sourceCounts && typeof sourceCounts === 'object' ? sourceCounts : {};
      const fallback = clamp(int(fallbackPerDay, DEFAULT_CONFIG.per_day), 1, 30);
      for (const area of areaNames) {
        out[area] = clamp(int(source[area], fallback), 1, 30);
      }
      return out;
    }
    function areaCountsToText(areaNames, areaCounts, fallbackPerDay) {
      return areaNames.map((area) => `${area}=${clamp(int(areaCounts?.[area], fallbackPerDay), 1, 30)}`).join('\n');
    }

    function applyHostTheme(payload) {
      if (!payload || typeof payload !== 'object') return;
      const root = document.documentElement;
      const map = {
        '--bg1': payload.bg1,
        '--bg2': payload.bg2,
        '--card': payload.card,
        '--line': payload.line,
        '--text': payload.text,
        '--muted': payload.muted,
        '--shadow': payload.shadow,
        '--input-bg': payload.input_bg,
        '--table-head': payload.table_head
      };
      for (const [key, value] of Object.entries(map)) {
        if (typeof value === 'string' && value.trim()) {
          root.style.setProperty(key, value.trim());
        }
      }
      root.setAttribute('data-host-theme', String(payload.mode || 'light'));
    }

    function toUniqueStudentName(baseName) {
      const normalized = String(baseName ?? '').trim();
      if (!normalized) return '';

      const existing = new Set(store.roster.map((x) => String(x?.name ?? '').trim()).filter(Boolean));
      if (!existing.has(normalized)) return normalized;

      let suffix = 2;
      while (existing.has(`${normalized}${suffix}`)) suffix += 1;
      return `${normalized}${suffix}`;
    }

    function normalizeConfig(input) {
      const raw = input && typeof input === 'object' ? input : {};
      const perDay = clamp(int(raw.per_day, DEFAULT_CONFIG.per_day), 1, 30);
      const areaNames = list(raw.area_names, DEFAULT_CONFIG.area_names);
      const areaCounts = normalizeAreaCounts(areaNames, raw.area_per_day_counts, perDay);
      return {
        python_path: String(raw.python_path ?? DEFAULT_CONFIG.python_path).trim() || DEFAULT_CONFIG.python_path,
        api_key: String(raw.api_key ?? ''),
        base_url: String(raw.base_url ?? DEFAULT_CONFIG.base_url).trim() || DEFAULT_CONFIG.base_url,
        model: String(raw.model ?? DEFAULT_CONFIG.model).trim() || DEFAULT_CONFIG.model,
        enable_auto_run: bool(raw.enable_auto_run, false),
        enable_mcp: bool(raw.enable_mcp, false),
        auto_run_day: String(raw.auto_run_day ?? 'Monday').trim() || 'Monday',
        auto_run_time: String(raw.auto_run_time ?? '08:00').trim() || '08:00',
        auto_run_coverage_days: clamp(int(raw.auto_run_coverage_days, 5), 1, 30),
        per_day: perDay,
        skip_weekends: bool(raw.skip_weekends, true),
        duty_rule: String(raw.duty_rule ?? ''),
        component_refresh_time: String(raw.component_refresh_time ?? '08:00').trim() || '08:00',
        area_names: areaNames,
        area_per_day_counts: areaCounts,
        notification_templates: list(raw.notification_templates, DEFAULT_CONFIG.notification_templates),
        start_from_today: bool(raw.start_from_today, false)
      };
    }

    function normalizeRoster(input) {
      if (!Array.isArray(input)) return [];
      const ids = new Set();
      const out = [];
      for (const r of input) {
        if (!r || typeof r !== 'object') continue;
        const id = int(r.id, NaN);
        const name = String(r.name ?? '').trim();
        if (!Number.isFinite(id) || id <= 0 || !name || ids.has(id)) continue;
        ids.add(id);
        out.push({ id, name, active: bool(r.active, true) });
      }
      out.sort((a, b) => a.id - b.id);
      return out;
    }

    function normalizeAssignments(raw) {
      const out = {};
      if (!raw || typeof raw !== 'object') return out;
      for (const [area, values] of Object.entries(raw)) {
        const key = String(area ?? '').trim();
        if (!key) continue;
        const arr = names(values);
        if (arr.length) out[key] = arr;
      }
      return out;
    }

    function normalizeItem(item) {
      if (!item || typeof item !== 'object') return null;
      const map = normalizeAssignments(item.area_assignments);
      const cls = names(item.classroom_students);
      const cln = names(item.cleaning_area_students);
      const stu = names(item.students);
      if (!Object.keys(map).length) {
        if (cls.length) map['教室'] = cls;
        if (cln.length) map['清洁区'] = cln;
        if (!cls.length && !cln.length && stu.length) map['教室'] = stu;
      }
      return {
        date: String(item.date ?? '').trim(),
        day: String(item.day ?? '').trim(),
        students: stu,
        classroom_students: cls,
        cleaning_area_students: cln,
        area_assignments: map
      };
    }

    function normalizeState(input) {
      const raw = input && typeof input === 'object' ? input : {};
      const state = { seed_anchor: String(raw.seed_anchor ?? ''), schedule_pool: [] };
      if (Array.isArray(raw.schedule_pool)) {
        for (const it of raw.schedule_pool) {
          const n = normalizeItem(it);
          if (n) state.schedule_pool.push(n);
        }
      }
      state.schedule_pool.sort((a, b) => a.date.localeCompare(b.date));
      return state;
    }

    function assignment(item, areaOrder = []) {
      const map = normalizeAssignments(item?.area_assignments);
      const ordered = {};
      for (const area of areaOrder) if (map[area]) ordered[area] = [...map[area]];
      for (const [k, v] of Object.entries(map)) if (!ordered[k]) ordered[k] = [...v];
      if (!Object.keys(ordered).length) {
        const cls = names(item?.classroom_students);
        const cln = names(item?.cleaning_area_students);
        const stu = names(item?.students);
        if (cls.length) ordered['教室'] = cls;
        if (cln.length) ordered['清洁区'] = cln;
        if (!cls.length && !cln.length && stu.length) ordered[areaOrder[0] || '教室'] = stu;
      }
      return ordered;
    }

    function isSecretKeyName(key) {
      const k = String(key || '').trim().toLowerCase();
      return k === 'api_key' ||
        k === 'apikey' ||
        k === 'encrypted_api_key' ||
        k === 'authorization' ||
        k === 'api-key' ||
        k === 'token';
    }

    function maskSecret(value) {
      const text = String(value ?? '').trim();
      if (!text) return '***';
      if (text.length <= 8) return '***';
      return `${text.slice(0, 4)}...${text.slice(-2)}`;
    }

    function sanitizeForLog(value, keyHint = '') {
      if (value === null || value === undefined) return value;
      if (Array.isArray(value)) {
        return value.map((item) => sanitizeForLog(item, keyHint));
      }
      if (typeof value === 'object') {
        const out = {};
        for (const [key, nested] of Object.entries(value)) {
          out[key] = isSecretKeyName(key) ? maskSecret(nested) : sanitizeForLog(nested, key);
        }
        return out;
      }
      if (typeof value === 'string') {
        if (isSecretKeyName(keyHint)) return maskSecret(value);
        if (/^bearer\s+/i.test(value.trim())) return 'Bearer ***';
      }
      return value;
    }

    function setRunInProgress(isRunning, statusText) {
      runInProgress = !!isRunning;
      const runBtn = $('runBtn');
      runBtn.disabled = runInProgress;
      runBtn.textContent = runInProgress ? '执行中...' : '执行排班';
      if (runInProgress) {
        setStatus('warn', statusText || '正在执行排班，请稍候...');
      }
    }

    function log(level, msg, payload) {
      const upper = String(level || 'INFO').toUpperCase();
      const entry = {
        time: now(),
        level: upper,
        text: String(msg || ''),
        payload: payload === undefined ? null : sanitizeForLog(payload)
      };
      logEntries.push(entry);
      if (logEntries.length > LOG_MAX) {
        logEntries.splice(0, logEntries.length - LOG_MAX);
      }
      renderLogs();
    }

    function renderLogs() {
      const lines = [];
      for (const entry of logEntries) {
        if (logFilter === 'error' && entry.level !== 'ERROR') {
          continue;
        }
        const label = LOG_LEVEL_LABELS[entry.level] || entry.level;
        const extra = entry.payload == null ? '' : `\n${JSON.stringify(entry.payload, null, 2)}`;
        lines.push(`[${entry.time}] [${label}] ${entry.text}${extra}`);
      }
      $('log').textContent = lines.join('\n');
      $('log').scrollTop = $('log').scrollHeight;
    }

    function clearLogs() {
      logEntries.length = 0;
      renderLogs();
    }

    function toggleErrorLogFilter() {
      logFilter = logFilter === 'error' ? 'all' : 'error';
      $('errorLogBtn').textContent = logFilter === 'error' ? '仅错误日志：开启' : '仅错误日志：关闭';
      renderLogs();
      log('INFO', logFilter === 'error' ? '已切换为仅错误日志。' : '已切换为显示全部日志。');
    }

    function setStatus(type, text) {
      const tagMap = { ok: '成功', err: '错误', warn: '处理中' };
      $('runTag').textContent = tagMap[type] || '状态';
      const cls = type === 'ok' ? 'status ok' : type === 'err' ? 'status err' : 'status';
      const dot = type === 'ok' ? 'dot ok' : type === 'err' ? 'dot err' : 'dot warn';
      $('runStatus').className = cls;
      $('runStatus').innerHTML = `<span class="${dot}"></span><span>${html(text)}</span>`;
    }

    function setAutoApplyStatus(type, text) {
      const node = $('autoApplyStatus');
      if (!node) return;
      const cls = type === 'ok' ? 'status ok slim' : type === 'err' ? 'status err slim' : 'status slim';
      const dot = type === 'ok' ? 'dot ok' : type === 'err' ? 'dot err' : 'dot warn';
      node.className = cls;
      node.innerHTML = `<span class="${dot}"></span><span>${html(text)}</span>`;
    }

    function applyConfigImmediate(reason, options) {
      const opts = options && typeof options === 'object' ? options : {};
      syncConfigFromForm();
      if (opts.maskApiInput) {
        $('cfgApi').value = String(store.config.api_key || '').trim() ? API_KEY_MASK : '';
      }
      if (runtimeMode === 'bridge') {
        const ok = bridgePost('save_config', { config: store.config });
        if (!ok) {
          setAutoApplyStatus('err', '配置自动同步失败：宿主不可用。');
          log('ERROR', '配置自动同步失败：宿主不可用。', { reason: reason || 'unknown' });
          return false;
        }
        if (!opts.quiet) {
          setAutoApplyStatus('ok', '配置已自动应用并同步到宿主。');
        }
        return true;
      }
      if (!opts.quiet) {
        setAutoApplyStatus('ok', '配置已自动应用（本地模式）。');
      }
      return true;
    }

    function applyRosterImmediate(reason, options) {
      const opts = options && typeof options === 'object' ? options : {};
      if (runtimeMode === 'bridge') {
        const ok = bridgePost('save_roster', { roster: store.roster });
        if (!ok) {
          setAutoApplyStatus('err', '名单自动同步失败：宿主不可用。');
          log('ERROR', '名单自动同步失败：宿主不可用。', { reason: reason || 'unknown' });
          return false;
        }
        if (!opts.quiet) {
          setAutoApplyStatus('ok', '名单已自动应用并同步到宿主。');
        }
        return true;
      }
      if (!opts.quiet) {
        setAutoApplyStatus('ok', '名单已自动应用（本地模式）。');
      }
      return true;
    }

    function bridgePost(action, payload) {
      const msg = { source: 'duty-agent-test-page', action, payload: payload || {} };
      if (!hasBridge) { log('WARN', `宿主不可用：${action}`, msg); return false; }
      window.chrome.webview.postMessage(msg);
      log('SEND', `发送到宿主：${action}`, msg.payload);
      return true;
    }

    function setMode(mode) {
      runtimeMode = mode === 'bridge' ? 'bridge' : 'mock';
      $('mode').value = runtimeMode;
      $('runtimeTag').textContent = runtimeMode === 'bridge' ? '运行模式：宿主模式' : '运行模式：本地模拟';
      log('INFO', `切换运行模式：${runtimeMode === 'bridge' ? '宿主模式' : '本地模拟'}`);
      if (runtimeMode === 'bridge' && hasBridge) {
        $('bridgeDot').className = 'dot ok';
        $('bridgeText').textContent = '宿主已连接';
        setAutoApplyStatus('ok', '自动应用已启用：配置与名单会立即同步宿主。');
        bridgePost('ready', { features: ['config', 'roster', 'state', 'run', 'notification'], version: 'test-html-1' });
      } else if (runtimeMode === 'bridge') {
        $('bridgeDot').className = 'dot warn';
        $('bridgeText').textContent = '宿主不可用';
        setAutoApplyStatus('warn', '自动应用仅保留本地：宿主不可用。');
      } else {
        $('bridgeDot').className = 'dot';
        $('bridgeText').textContent = '宿主未启用';
        setAutoApplyStatus('ok', '自动应用已启用：本地修改即时生效。');
      }
    }

    function setLocalPreviewUrl(url) {
      const text = String(url || '').trim();
      localPreviewUrl = text;
      $('previewUrlTag').textContent = text ? `本地调试URL：${text}` : '本地调试URL：-';
      if (!apiOverwriteUrl && text) {
        try {
          setApiOverwriteUrl(`${new URL(text).origin}/api/v1/schedule/overwrite`);
        } catch {
        }
      }
    }

    function setApiOverwriteUrl(url) {
      const text = String(url || '').trim();
      apiOverwriteUrl = text;
      $('apiOverwriteUrlTag').textContent = text ? `覆盖排班API：${text}` : '覆盖排班API：-';
      if (text) {
        try {
          $('apiBaseUrl').value = new URL(text).origin;
        } catch {
        }
      }
    }

    function resolveOverwriteApiEndpoint() {
      const fromInput = String($('apiBaseUrl').value || '').trim();
      if (fromInput) {
        return `${fromInput.replace(/\/+$/, '')}/api/v1/schedule/overwrite`;
      }
      if (apiOverwriteUrl) {
        return apiOverwriteUrl;
      }
      if (localPreviewUrl) {
        try {
          return `${new URL(localPreviewUrl).origin}/api/v1/schedule/overwrite`;
        } catch {
        }
      }
      if (window.location.protocol.startsWith('http')) {
        return `${window.location.origin}/api/v1/schedule/overwrite`;
      }
      return '';
    }

    function renderOptions(selectId, values) {
      const el = $(selectId);
      el.innerHTML = '';
      for (const v of values) {
        const op = document.createElement('option');
        op.value = v;
        op.textContent = v;
        el.appendChild(op);
      }
      if (el.options.length) el.selectedIndex = 0;
    }

    function renderConfig() {
      const c = store.config;
      $('cfgApi').value = String(c.api_key || '').trim() ? API_KEY_MASK : '';
      $('cfgBase').value = c.base_url;
      $('cfgModel').value = c.model;
      $('cfgAuto').value = String(c.enable_auto_run);
      $('cfgEnableMcp').value = String(c.enable_mcp);
      $('cfgDay').value = c.auto_run_day;
      $('cfgTime').value = c.auto_run_time;
      $('cfgDays').value = c.auto_run_coverage_days;
      $('cfgPer').value = c.per_day;
      $('cfgRefresh').value = c.component_refresh_time;
      $('cfgSkip').value = String(c.skip_weekends);
      $('cfgAreaCounts').value = areaCountsToText(c.area_names, c.area_per_day_counts, c.per_day);
      $('cfgRule').value = c.duty_rule;
      renderOptions('areaList', c.area_names);
      renderOptions('tplList', c.notification_templates);
    }

    function syncConfigFromForm() {
      const inputApiKey = $('cfgApi').value;
      const keepCurrentMasks = new Set([API_KEY_MASK, LEGACY_API_KEY_MASK, HOST_API_KEY_MASK]);
      const apiKey = keepCurrentMasks.has(inputApiKey)
        ? (String(store.config.api_key || '').trim() || HOST_API_KEY_MASK)
        : inputApiKey;
      const areaNames = Array.from($('areaList').options).map((x) => x.value);
      store.config = normalizeConfig({
        ...store.config,
        python_path: store.config.python_path,
        api_key: apiKey,
        base_url: $('cfgBase').value,
        model: $('cfgModel').value,
        enable_auto_run: $('cfgAuto').value,
        enable_mcp: $('cfgEnableMcp').value,
        auto_run_day: $('cfgDay').value,
        auto_run_time: $('cfgTime').value,
        auto_run_coverage_days: $('cfgDays').value,
        per_day: $('cfgPer').value,
        skip_weekends: $('cfgSkip').value,
        duty_rule: $('cfgRule').value,
        component_refresh_time: $('cfgRefresh').value,
        area_names: areaNames,
        area_per_day_counts: parseAreaCountsText($('cfgAreaCounts').value),
        notification_templates: Array.from($('tplList').options).map((x) => x.value)
      });
    }

    function rosterStats() {
      const cnt = new Map();
      const nxt = new Map();
      const td = today();
      const pool = [...store.state.schedule_pool].sort((a, b) => a.date.localeCompare(b.date));

      for (const item of pool) {
        const d = parseIso(item.date);
        if (!d) continue;
        const set = new Set();
        const map = assignment(item, store.config.area_names);
        for (const arr of Object.values(map)) for (const n of arr) if (n) set.add(n);
        for (const n of set) {
          cnt.set(n, (cnt.get(n) || 0) + 1);
          if (d >= td) {
            const old = nxt.get(n);
            if (!old || d < old) nxt.set(n, d);
          }
        }
      }

      const rows = store.roster.map((r) => ({
        id: r.id,
        name: r.name,
        active: r.active,
        next: nxt.get(r.name) ? dateIso(nxt.get(r.name)) : '未安排',
        count: cnt.get(r.name) || 0
      }));

      rows.sort((a, b) => {
        const au = a.next === '未安排';
        const bu = b.next === '未安排';
        if (au !== bu) return au ? 1 : -1;
        if (!au && a.next !== b.next) return a.next.localeCompare(b.next);
        return a.id - b.id;
      });
      return rows;
    }

    function renderRoster() {
      const rows = rosterStats();
      $('rosterBody').innerHTML = '';
      for (const r of rows) {
        const tr = document.createElement('tr');
        tr.dataset.id = String(r.id);
        if (r.id === selectedRosterId) tr.className = 'sel';
        tr.innerHTML = `<td class="mono">${r.id}</td><td>${html(r.name)}</td><td class="mono">${html(r.next)}</td><td class="mono">${r.count}</td><td><label class="active-cell"><input class="roster-active" type="checkbox" ${r.active ? 'checked' : ''}><span>${r.active ? '启用' : '停用'}</span></label></td>`;
        const activeInput = tr.querySelector('.roster-active');
        if (activeInput) {
          activeInput.addEventListener('click', (event) => event.stopPropagation());
          activeInput.addEventListener('change', () => {
            const target = store.roster.find((x) => x.id === r.id);
            if (!target) return;
            target.active = !!activeInput.checked;
            renderRoster();
            applyRosterImmediate('toggle_active', { quiet: true });
            setStatus('ok', `已${target.active ? '启用' : '停用'}：${target.name}`);
          });
        }
        tr.addEventListener('click', () => { selectedRosterId = r.id; renderRoster(); });
        $('rosterBody').appendChild(tr);
      }
    }

    function allAreaNames() {
      const out = [...store.config.area_names];
      const set = new Set(out);
      for (const item of store.state.schedule_pool) {
        for (const k of Object.keys(assignment(item, out))) {
          if (!set.has(k)) { set.add(k); out.push(k); }
        }
      }
      return out;
    }
    function renderSchedule() {
      const areas = allAreaNames();
      $('scheduleHead').innerHTML = `<tr><th>日期</th><th>星期</th>${areas.map((a) => `<th>${html(a)}</th>`).join('')}</tr>`;
      const pool = [...store.state.schedule_pool].sort((a, b) => a.date.localeCompare(b.date));
      if (!pool.length) {
        $('scheduleBody').innerHTML = `<tr><td colspan="${2 + areas.length}">暂无排班数据</td></tr>`;
        return;
      }
      $('scheduleBody').innerHTML = '';
      for (const it of pool) {
        const map = assignment(it, areas);
        const tr = document.createElement('tr');
        const cells = [`<td class="mono">${html(it.date)}</td>`, `<td class="mono">${html(it.day)}</td>`];
        for (const a of areas) cells.push(`<td>${html((map[a] || []).join(', ') || '-')}</td>`);
        tr.innerHTML = cells.join('');
        $('scheduleBody').appendChild(tr);
      }
    }

    function renderLegacy() {
      const pool = [...store.state.schedule_pool].sort((a, b) => a.date.localeCompare(b.date));
      $('legacyBody').innerHTML = '';
      if (!pool.length) {
        $('legacyBody').innerHTML = '<tr><td colspan="3">暂无排班数据</td></tr>';
        return;
      }
      for (const it of pool) {
        const map = assignment(it, store.config.area_names);
        const c1 = map['教室'] || names(it.classroom_students);
        const c2 = map['清洁区'] || names(it.cleaning_area_students);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="mono">${html(it.date)}</td><td>${html(c1.join(', ') || '-')}</td><td>${html(c2.join(', ') || '-')}</td>`;
        $('legacyBody').appendChild(tr);
      }
    }

    function renderAll() {
      renderConfig();
      renderRoster();
      renderSchedule();
      renderLegacy();
      $('runtimeTag').textContent = runtimeMode === 'bridge' ? '运行模式：宿主模式' : '运行模式：本地模拟';
    }

    function startDateFromConfig(applyMode) {
      const pool = [...store.state.schedule_pool].sort((a, b) => a.date.localeCompare(b.date));
      if (applyMode === 'append') {
        if (store.config.start_from_today) {
          return today();
        }
        if (pool.length) {
          const last = parseIso(pool[pool.length - 1].date);
          if (last) return addDays(last, 1);
        }
        return today();
      }
      return today();
    }

    function targetDates(start, days, skipWeekends) {
      const out = [];
      let d = new Date(start);
      while (out.length < days) {
        const w = d.getDay();
        if (!(skipWeekends && (w === 0 || w === 6))) out.push(new Date(d));
        d = addDays(d, 1);
      }
      return out;
    }

    function lastAssignedName(pool, areas, applyMode, startDate) {
      const start = dateIso(startDate);
      const src = applyMode === 'append' ? pool : pool.filter((x) => x.date < start);
      for (let i = src.length - 1; i >= 0; i--) {
        const map = assignment(src[i], areas);
        const keys = [...areas, ...Object.keys(map).filter((k) => !areas.includes(k))];
        for (const k of keys) {
          const arr = map[k] || [];
          if (arr.length) return arr[arr.length - 1];
        }
      }
      return null;
    }

    function dedupeByDate(items) {
      const map = new Map();
      for (const item of items) {
        const key = String(item?.date ?? '').trim();
        if (!key) continue;
        map.set(key, item);
      }
      return [...map.entries()].sort((a, b) => a[0].localeCompare(b[0])).map(([, v]) => v);
    }

    function mergeSchedule(existing, generated, applyMode, startDate) {
      const cur = [...existing].sort((a, b) => a.date.localeCompare(b.date));
      const start = dateIso(startDate);
      const td = dateIso(today());
      if (applyMode === 'replace_all') return dedupeByDate([...generated]);
      if (applyMode === 'replace_future') return dedupeByDate([...cur.filter((x) => x.date < start), ...generated]);
      if (applyMode === 'replace_overlap') {
        const end = generated.length ? generated[generated.length - 1].date : start;
        return dedupeByDate([...cur.filter((x) => x.date < start || x.date > end), ...generated]);
      }
      return dedupeByDate([...cur, ...generated]);
    }

    function runMockInternal(daysToGenerate, applyMode, instruction, detailText) {
      syncConfigFromForm();
      const areas = list(store.config.area_names, DEFAULT_CONFIG.area_names);
      const per = clamp(int(store.config.per_day, 2), 1, 30);
      const areaCounts = normalizeAreaCounts(areas, store.config.area_per_day_counts, per);
      const totalPerDay = Object.values(areaCounts).reduce((sum, value) => sum + value, 0);
      const days = clamp(int(daysToGenerate, 1), 1, 30);
      const active = store.roster.filter((r) => r.active && r.name).sort((a, b) => a.id - b.id);
      if (!active.length) {
        setStatus('err', '没有可排班的启用学生。');
        log('ERROR', '模拟排班失败：没有可排班的启用学生。');
        return;
      }

      const start = startDateFromConfig(applyMode);
      const dates = targetDates(start, days, store.config.skip_weekends);
      const anchor = lastAssignedName(store.state.schedule_pool, areas, applyMode, start);
      let idx = active.length - 1;
      if (anchor) {
        const p = active.findIndex((x) => x.name === anchor);
        if (p >= 0) idx = p;
      }
      let cursor = (idx + 1) % active.length;

      const generated = [];
      for (const d of dates) {
        const used = new Set();
        const map = {};
        for (const area of areas) {
          const arr = [];
          const requiredCount = areaCounts[area];
          const noDupAcrossArea = totalPerDay <= active.length;
          let guard = 0;
          while (arr.length < requiredCount && guard < active.length * 4) {
            const stu = active[cursor];
            cursor = (cursor + 1) % active.length;
            guard++;
            if (!stu || arr.includes(stu.name)) continue;
            if (noDupAcrossArea && used.has(stu.name)) continue;
            arr.push(stu.name);
            used.add(stu.name);
          }
          while (arr.length < requiredCount) {
            const stu = active[cursor];
            cursor = (cursor + 1) % active.length;
            if (!stu || arr.includes(stu.name)) break;
            arr.push(stu.name);
          }
          map[area] = arr;
        }

        const a1 = areas[0];
        const a2 = areas.length > 1 ? areas[1] : a1;
        generated.push({
          date: dateIso(d),
          day: DAY[d.getDay()],
          students: map[a1] ? [...map[a1]] : [],
          classroom_students: map[a1] ? [...map[a1]] : [],
          cleaning_area_students: map[a2] ? [...map[a2]] : [],
          area_assignments: map
        });
      }

      store.state.schedule_pool = mergeSchedule(store.state.schedule_pool, generated, applyMode, start);
      store.state = normalizeState(store.state);
      renderAll();
      setStatus('ok', `模拟排班成功，生成 ${generated.length} 天。`);
      log('OK', '模拟排班成功。', {
        generated_days: generated.length,
        apply_mode: applyMode,
        areas,
        per_day: per,
        area_per_day_counts: areaCounts
      });

      notifyByTemplates(
        'manual',
        true,
        detailText || '模拟执行成功',
        instruction,
        applyMode,
        clamp(int($('nDuration').value, 7), 1, 30),
        false
      );
    }

    function runMock() {
      const instruction = $('instruction').value.trim();
      const applyMode = $('applyMode').value;
      if (!instruction) {
        setStatus('err', '请输入排班指令。');
        log('ERROR', '模拟排班失败：排班指令为空。');
        return;
      }

      const days = clamp(int($('cfgDays').value, store.config.auto_run_coverage_days), 1, 30);
      log('INFO', '开始执行模拟排班。', { mode: applyMode, days });
      runMockInternal(days, applyMode, instruction, $('runDetail').value.trim() || '模拟执行成功');
    }

    function buildOverwriteApiPayload(instruction) {
      syncConfigFromForm();
      return {
        instruction,
        config: {
          api_key: store.config.api_key,
          base_url: store.config.base_url,
          model: store.config.model,
          auto_run_coverage_days: store.config.auto_run_coverage_days,
          per_day: store.config.per_day,
          skip_weekends: store.config.skip_weekends,
          duty_rule: store.config.duty_rule,
          start_from_today: store.config.start_from_today,
          python_path: store.config.python_path,
          area_names: store.config.area_names,
          area_per_day_counts: store.config.area_per_day_counts
        }
      };
    }

    async function runOverwriteByApi() {
      const instruction = String($('apiInstruction').value || '').trim() || String($('instruction').value || '').trim();
      if (!instruction) {
        setStatus('err', '请输入覆盖排班指令。');
        $('apiStatus').value = '失败';
        log('ERROR', '本地接口覆盖排班失败：排班指令为空。');
        return;
      }

      const endpoint = resolveOverwriteApiEndpoint();
      if (!endpoint) {
        setStatus('err', '未能解析覆盖排班 API 地址。');
        $('apiStatus').value = '失败';
        log('ERROR', '本地接口覆盖排班失败：API 地址不可用。');
        return;
      }

      const payload = buildOverwriteApiPayload(instruction);
      const button = $('apiOverwriteBtn');
      button.disabled = true;
      $('apiStatus').value = '请求中...';
      try {
        log('INFO', '开始请求本地覆盖排班 API。', { endpoint, instruction_length: instruction.length });
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        const text = await response.text();
        let data = null;
        try {
          data = JSON.parse(text);
        } catch {
        }

        $('apiResponse').value = data ? JSON.stringify(data, null, 2) : text;
        if (!response.ok || !data || data.success !== true) {
          const message = (data && data.message) ? String(data.message) : `HTTP ${response.status}`;
          $('apiStatus').value = `失败(${response.status})`;
          setStatus('err', `接口覆盖排班失败：${message}`);
          log('ERROR', '本地接口覆盖排班失败。', { status: response.status, response: data ?? text });
          return;
        }

        $('apiStatus').value = '成功';
        if (data.state) {
          store.state = normalizeState(data.state);
          renderAll();
        }
        if (typeof data.preview_url === 'string') {
          setLocalPreviewUrl(data.preview_url);
        }
        if (typeof data.api_overwrite_url === 'string') {
          setApiOverwriteUrl(data.api_overwrite_url);
        }

        setStatus('ok', '接口覆盖排班成功。');
        log('OK', '本地接口覆盖排班成功。', {
          code: data.code || 'ok',
          message: data.message || '',
          duration_ms: data.duration_ms || 0
        });
      } catch (e) {
        const message = e instanceof Error ? e.message : String(e);
        $('apiStatus').value = '失败';
        setStatus('err', `接口覆盖排班失败：${message}`);
        log('ERROR', '本地接口覆盖排班异常。', { message, endpoint });
      } finally {
        button.disabled = false;
      }
    }

    function renderTpl(tpl, tokens) {
      return String(tpl || '').replace(/\{([a-zA-Z0-9_]+)\}/g, (_, k) => (k in tokens ? tokens[k] : `{${k}}`)).trim();
    }

    function notifyByTemplates(scene, success, detail, instruction, applyMode, duration, sendHost) {
      syncConfigFromForm();
      const sceneText = scene === 'auto' ? '自动排班' : '手动排班';
      const statusText = success ? '成功' : '失败';
      const tok = {
        scene: sceneText,
        status: statusText,
        date: `${dateIso(today())} ${new Date().toTimeString().slice(0, 5)}`,
        areas: list(store.config.area_names, DEFAULT_CONFIG.area_names).join('、'),
        days: String(store.config.auto_run_coverage_days),
        per_day: String(store.config.per_day),
        mode: applyMode || $('applyMode').value,
        instruction: String(instruction || '').trim().slice(0, 80),
        message: String(detail || '').trim().slice(0, 100)
      };

      const seen = new Set();
      const msgs = [];
      for (const tpl of list(store.config.notification_templates, DEFAULT_CONFIG.notification_templates)) {
        const txt = renderTpl(tpl, tok);
        if (!txt || seen.has(txt)) continue;
        seen.add(txt);
        msgs.push(txt);
      }
      if (!msgs.length) msgs.push(`${sceneText}${statusText}，日期：${tok.date}`);

      $('noticeList').innerHTML = '';
      for (const m of msgs) {
        const div = document.createElement('div');
        div.className = `notice ${success ? '' : 'fail'}`.trim();
        div.textContent = m;
        $('noticeList').appendChild(div);
        if (sendHost && runtimeMode === 'bridge') {
          bridgePost('publish_notification', { text: m, duration_seconds: duration });
        }
      }

      log('INFO', `通知模板渲染完成 (${msgs.length} 条)。`, { scene, success, tokens: tok });
    }

    function triggerRunCompletionNotification() {
      const payload = {
        instruction: $('instruction').value.trim(),
        apply_mode: $('applyMode').value,
        message: $('runDetail').value.trim() || $('nMsg').value.trim()
      };
      const ok = bridgePost('trigger_run_completion_notification', payload);
      if (ok) {
        setStatus('warn', '已触发完成排班通知。');
        log('OK', '已请求宿主触发完成排班通知。', payload);
      } else {
        setStatus('err', '宿主不可用，无法触发完成排班通知。');
        log('ERROR', '触发完成排班通知失败：宿主不可用。');
      }
    }

    function triggerDutyReminderNotification() {
      const nowDate = dateIso(today());
      const nowTime = new Date().toTimeString().slice(0, 5);
      const payload = { date: nowDate, time: nowTime };
      const ok = bridgePost('trigger_duty_reminder_notification', payload);
      if (ok) {
        setStatus('warn', '已触发值日提醒通知。');
        log('OK', '已请求宿主触发值日提醒通知。', payload);
      } else {
        setStatus('err', '宿主不可用，无法触发值日提醒通知。');
        log('ERROR', '触发值日提醒通知失败：宿主不可用。');
      }
    }

    function openTestInBrowser() {
      if (runtimeMode === 'bridge') {
        const ok = bridgePost('open_test_in_browser', {});
        if (ok) {
          setStatus('warn', '已请求宿主在本地浏览器打开 test.html。');
          log('OK', '已请求宿主在本地浏览器打开 test.html。');
        } else {
          setStatus('err', '宿主不可用，无法请求打开。');
          log('ERROR', '请求宿主打开浏览器失败：宿主不可用。');
        }
        return;
      }

      const target = localPreviewUrl || window.location.href;
      window.open(target, '_blank');
      setStatus('ok', '已在浏览器打开 test.html。');
      log('OK', '已在浏览器打开 test.html。', { target });
    }

    function runBridge() {
      if (runInProgress) {
        setStatus('warn', '已有排班任务在执行中，请稍候。');
        log('WARN', '忽略重复执行请求：已有任务进行中。');
        return;
      }
      syncConfigFromForm();
      const instruction = $('instruction').value.trim();
      const applyMode = $('applyMode').value;
      if (!instruction) {
        setStatus('err', '请输入排班指令。');
        log('ERROR', '宿主排班失败：排班指令为空。');
        return;
      }
      log('INFO', '开始请求宿主执行排班。', { mode: applyMode });
      setRunInProgress(true, '正在执行排班，请稍候...');
      const ok = bridgePost('run_core', { instruction, apply_mode: applyMode, config: store.config });
      setStatus(ok ? 'warn' : 'err', ok ? '已发送排班请求到宿主。' : '宿主不可用，无法发送排班请求。');
      if (!ok) {
        setRunInProgress(false);
        log('ERROR', '宿主排班失败：宿主不可用。');
      }
    }

    function addArea() {
      const name = $('newArea').value.trim();
      if (!name) {
        setStatus('err', '区域名不能为空。');
        log('ERROR', '新增区域失败：区域名为空。');
        return;
      }
      syncConfigFromForm();
      if (store.config.area_names.includes(name)) {
        setStatus('err', '区域已存在。');
        log('ERROR', '新增区域失败：区域已存在。', { area: name });
        return;
      }
      store.config.area_names.push(name);
      store.config.area_per_day_counts[name] = clamp(int(store.config.per_day, DEFAULT_CONFIG.per_day), 1, 30);
      $('newArea').value = '';
      renderConfig();
      renderSchedule();
      applyConfigImmediate('add_area', { quiet: true });
      setStatus('ok', `已新增区域：${name}`);
      log('OK', '已新增区域。', { area: name });
    }

    function delArea() {
      syncConfigFromForm();
      const v = $('areaList').value;
      if (!v) {
        setStatus('err', '请先选择区域。');
        log('ERROR', '删除区域失败：未选择区域。');
        return;
      }
      if (store.config.area_names.length <= 1) {
        setStatus('err', '至少保留一个区域。');
        log('ERROR', '删除区域失败：区域数量不能少于 1。');
        return;
      }
      store.config.area_names = store.config.area_names.filter((x) => x !== v);
      if (store.config.area_per_day_counts && typeof store.config.area_per_day_counts === 'object') {
        delete store.config.area_per_day_counts[v];
      }
      renderConfig();
      renderSchedule();
      applyConfigImmediate('del_area', { quiet: true });
      setStatus('ok', `已删除区域：${v}`);
      log('OK', '已删除区域。', { area: v });
    }

    function addTpl() {
      const text = $('newTpl').value.trim();
      if (!text) {
        setStatus('err', '模板不能为空。');
        log('ERROR', '新增通知模板失败：模板为空。');
        return;
      }
      syncConfigFromForm();
      if (store.config.notification_templates.includes(text)) {
        setStatus('err', '模板已存在。');
        log('ERROR', '新增通知模板失败：模板已存在。');
        return;
      }
      store.config.notification_templates.push(text);
      $('newTpl').value = '';
      renderConfig();
      applyConfigImmediate('add_template', { quiet: true });
      setStatus('ok', '通知模板已新增。');
      log('OK', '已新增通知模板。', { template: text });
    }

    function delTpl() {
      syncConfigFromForm();
      const v = $('tplList').value;
      if (!v) {
        setStatus('err', '请先选择模板。');
        log('ERROR', '删除通知模板失败：未选择模板。');
        return;
      }
      if (store.config.notification_templates.length <= 1) {
        setStatus('err', '至少保留一个模板。');
        log('ERROR', '删除通知模板失败：模板数量不能少于 1。');
        return;
      }
      store.config.notification_templates = store.config.notification_templates.filter((x) => x !== v);
      renderConfig();
      applyConfigImmediate('del_template', { quiet: true });
      setStatus('ok', '通知模板已删除。');
      log('OK', '已删除通知模板。', { template: v });
    }

    function addStudent() {
      const baseName = $('newStudent').value.trim();
      if (!baseName) {
        setStatus('err', '学生姓名不能为空。');
        log('ERROR', '新增学生失败：姓名为空。');
        return;
      }
      const name = toUniqueStudentName(baseName);
      const nextId = store.roster.length ? Math.max(...store.roster.map((x) => x.id)) + 1 : 1;
      store.roster.push({ id: nextId, name, active: true });
      $('newStudent').value = '';
      selectedRosterId = nextId;
      renderRoster();
      applyRosterImmediate('add_student', { quiet: true });
      const renamed = name !== baseName;
      setStatus('ok', renamed
        ? `检测到同名，已自动命名为：${name} (ID ${nextId})`
        : `已添加学生：${name} (ID ${nextId})`);
      log('OK', renamed ? '已添加学生（同名自动重命名）。' : '已添加学生。', { id: nextId, requested: baseName, final: name });
    }

    function delStudent() {
      if (selectedRosterId == null) {
        setStatus('err', '请先在表格中选择学生。');
        log('ERROR', '删除学生失败：未选择学生。');
        return;
      }
      const before = store.roster.length;
      store.roster = store.roster.filter((x) => x.id !== selectedRosterId);
      if (store.roster.length === before) {
        setStatus('err', '未找到选中学生。');
        log('ERROR', '删除学生失败：未找到对应 ID。', { id: selectedRosterId });
        return;
      }
      selectedRosterId = null;
      renderRoster();
      applyRosterImmediate('del_student', { quiet: true });
      setStatus('ok', '已删除选中学生。');
      log('OK', '已删除学生。');
    }

    function exportSnapshot() {
      syncConfigFromForm();
      const out = clone(store);
      if (out.config.api_key && String(out.config.api_key).trim()) out.config.api_key = API_KEY_MASK;
      $('snapshot').value = JSON.stringify(out, null, 2);
      setStatus('ok', '快照导出成功。');
      log('INFO', '快照已导出（API Key 已掩码）。');
    }

    function importSnapshot() {
      const txt = $('snapshot').value.trim();
      if (!txt) {
        setStatus('err', '请先粘贴快照 JSON。');
        log('ERROR', '导入快照失败：输入为空。');
        return;
      }
      try {
        const parsed = JSON.parse(txt);
        const oldKey = store.config.api_key;
        const cfg = normalizeConfig(parsed.config);
        if (cfg.api_key === API_KEY_MASK || cfg.api_key === LEGACY_API_KEY_MASK || cfg.api_key === HOST_API_KEY_MASK) cfg.api_key = oldKey;
        store = {
          config: cfg,
          roster: normalizeRoster(parsed.roster),
          state: normalizeState(parsed.state)
        };
        selectedRosterId = null;
        renderAll();
        applyConfigImmediate('import_snapshot', { quiet: true, maskApiInput: true });
        applyRosterImmediate('import_snapshot', { quiet: true });
        setStatus('ok', '快照导入成功。');
        log('OK', '快照导入成功。');
      } catch (e) {
        const message = e instanceof Error ? e.message : String(e);
        setStatus('err', `快照导入失败：${message}`);
        log('ERROR', '快照导入失败。', { message });
      }
    }

    function resetAll() {
      store = {
        config: normalizeConfig(DEFAULT_CONFIG),
        roster: normalizeRoster(DEFAULT_ROSTER),
        state: normalizeState(DEFAULT_STATE)
      };
      selectedRosterId = null;
      $('snapshot').value = '';
      $('instruction').value = '';
      $('runDetail').value = '';
      $('nMsg').value = '';
      $('noticeList').innerHTML = '';
      renderAll();
      applyConfigImmediate('reset_all', { quiet: true });
      applyRosterImmediate('reset_all', { quiet: true });
      setStatus('ok', '已重置为默认测试数据。');
      log('OK', '已重置为默认测试数据。');
    }

    function applyHost(data) {
      if (!data || typeof data !== 'object') {
        log('WARN', '收到无效宿主消息。', data);
        return;
      }
      let changed = false;
      if ('config' in data) { store.config = normalizeConfig(data.config); changed = true; }
      if ('roster' in data) { store.roster = normalizeRoster(data.roster); changed = true; }
      if ('state' in data) { store.state = normalizeState(data.state); changed = true; }
      if (data.type === 'host_theme' && data.payload) {
        applyHostTheme(data.payload);
      }
      if (data.type === 'run_status') {
        const phase = String(data.phase || '').trim().toLowerCase();
        const message = String(data.message || '').trim();
        if (phase === 'started' || phase === 'running') {
          setRunInProgress(true, message || '正在执行排班，请稍候...');
        } else if (phase === 'completed' || phase === 'failed' || phase === 'error') {
          setRunInProgress(false);
        }
        log('INFO', '宿主执行状态更新。', { phase, message });
      }
      if (data.type === 'run_result') {
        setRunInProgress(false);
        const ok = !!data.success;
        const message = data.message || '未知错误';
        setStatus(ok ? 'ok' : 'err', ok ? '宿主排班成功。' : `宿主排班失败：${message}`);
        if (data.message) $('nMsg').value = String(data.message);
        log(ok ? 'OK' : 'ERROR', ok ? '宿主排班成功。' : '宿主排班失败。', { message });
        const aiResponse = String(data.ai_response || '').trim();
        if (aiResponse) {
          log('INFO', 'AI 返回内容。', { ai_response: aiResponse });
        }
      }
      if (data.type === 'error') {
        if (String(data.action || '').trim().toLowerCase() === 'run_core') {
          setRunInProgress(false);
        }
        log('ERROR', `宿主返回错误：${data.code || '未知错误'}`, data);
      }
      if (changed) {
        selectedRosterId = null;
        renderAll();
        log('INFO', '已应用宿主返回的最新数据。');
      }

      if (typeof data.local_preview_url === 'string') {
        setLocalPreviewUrl(data.local_preview_url);
      }
      if (typeof data.api_overwrite_url === 'string') {
        setApiOverwriteUrl(data.api_overwrite_url);
      }
    }

    function bindConfigAutoApply() {
      const configFieldIds = [
        'cfgApi', 'cfgBase', 'cfgModel',
        'cfgAuto', 'cfgEnableMcp', 'cfgDay', 'cfgTime',
        'cfgDays', 'cfgPer', 'cfgRefresh', 'cfgSkip',
        'cfgAreaCounts', 'cfgRule'
      ];

      for (const id of configFieldIds) {
        const el = $(id);
        if (!el) continue;
        const tag = el.tagName.toLowerCase();
        const maskApiInput = id === 'cfgApi';
        if (tag === 'select') {
          el.addEventListener('change', () => {
            applyConfigImmediate(`change:${id}`, { maskApiInput });
          });
          continue;
        }
        if (tag === 'textarea') {
          el.addEventListener('blur', () => {
            applyConfigImmediate(`blur:${id}`, { maskApiInput });
          });
          el.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && (event.ctrlKey || event.metaKey)) {
              event.preventDefault();
              applyConfigImmediate(`hotkey:${id}`, { maskApiInput });
            }
          });
          continue;
        }
        el.addEventListener('blur', () => {
          applyConfigImmediate(`blur:${id}`, { maskApiInput });
        });
        el.addEventListener('keydown', (event) => {
          if (event.key === 'Enter') {
            event.preventDefault();
            el.blur();
          }
        });
      }
    }

    function bind() {
      $('mode').addEventListener('change', () => setMode($('mode').value));
      $('runBtn').addEventListener('click', () => runtimeMode === 'bridge' ? runBridge() : runMock());
      $('apiOverwriteBtn').addEventListener('click', () => { void runOverwriteByApi(); });
      $('instruction').addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && (event.ctrlKey || event.metaKey)) {
          event.preventDefault();
          runtimeMode === 'bridge' ? runBridge() : runMock();
        }
      });
      $('apiInstruction').addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && (event.ctrlKey || event.metaKey)) {
          event.preventDefault();
          void runOverwriteByApi();
        }
      });
      $('loadBtn').addEventListener('click', () => {
        log('INFO', '触发加载数据。', { mode: runtimeMode });
        if (runtimeMode === 'bridge') {
          const ok = bridgePost('load_all', {});
          setStatus(ok ? 'warn' : 'err', ok ? '已请求宿主加载数据。' : '宿主不可用，无法加载。');
          if (!ok) {
            log('ERROR', '加载数据失败：宿主不可用。');
          }
        } else {
          renderAll();
          setStatus('ok', '本地模拟数据已刷新。');
          log('OK', '本地模拟数据已刷新。');
        }
      });

      $('addArea').addEventListener('click', addArea);
      $('delArea').addEventListener('click', delArea);
      $('addTpl').addEventListener('click', addTpl);
      $('delTpl').addEventListener('click', delTpl);
      $('addStudent').addEventListener('click', addStudent);
      $('delStudent').addEventListener('click', delStudent);
      $('newArea').addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          addArea();
        }
      });
      $('newTpl').addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          addTpl();
        }
      });
      $('newStudent').addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          addStudent();
        }
      });
      bindConfigAutoApply();

      $('previewNotice').addEventListener('click', () => {
        notifyByTemplates($('nScene').value, $('nStatus').value === 'success', $('nMsg').value.trim(), $('instruction').value.trim(), $('applyMode').value, clamp(int($('nDuration').value, 7), 1, 30), false);
        setStatus('ok', '通知模板预览已更新。');
        log('OK', '通知模板预览完成。');
      });

      $('sendNotice').addEventListener('click', () => {
        notifyByTemplates($('nScene').value, $('nStatus').value === 'success', $('nMsg').value.trim(), $('instruction').value.trim(), $('applyMode').value, clamp(int($('nDuration').value, 7), 1, 30), true);
        if (runtimeMode === 'bridge' && hasBridge) setStatus('warn', '通知已发送到宿主。');
        else setStatus('ok', '宿主不可用，仅本地预览。');
      });
      $('triggerRunCompletionNotice').addEventListener('click', triggerRunCompletionNotification);
      $('triggerDutyReminderNotice').addEventListener('click', triggerDutyReminderNotification);
      $('openInBrowserBtn').addEventListener('click', openTestInBrowser);

      $('exportBtn').addEventListener('click', exportSnapshot);
      $('importBtn').addEventListener('click', importSnapshot);
      $('resetBtn').addEventListener('click', resetAll);
      $('clearLogBtn').addEventListener('click', () => {
        clearLogs();
        setStatus('ok', '日志已清空。');
      });
      $('errorLogBtn').addEventListener('click', toggleErrorLogFilter);

      if (hasBridge) {
        window.chrome.webview.addEventListener('message', (event) => {
          log('RECV', '接收到宿主消息。', event.data);
          applyHost(event.data);
        });
      }
    }

    bind();
    setMode(hasBridge ? 'bridge' : 'mock');
    renderAll();
    requestAnimationFrame(() => document.body.classList.add('page-ready'));
    if (window.location.protocol.startsWith('http')) {
      setLocalPreviewUrl(window.location.href);
      setApiOverwriteUrl(`${window.location.origin}/api/v1/schedule/overwrite`);
    }
    setStatus('warn', '测试控制台已就绪。');
    log('INFO', '页面初始化完成。');
  </script>
</body>

</html>