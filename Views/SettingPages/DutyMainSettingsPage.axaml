<ci:SettingsPageBase x:Class="DutyIsland.Views.SettingPages.DutyMainSettingsPage"
                     xmlns="https://github.com/avaloniaui"
                     xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                     xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                     xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                     xmlns:ci="http://classisland.tech/schemas/xaml/core"
                     xmlns:local="clr-namespace:DutyIsland.Views.SettingPages"
                     x:DataType="local:DutyMainSettingsPage"
                     d:DataContext="{d:DesignInstance local:DutyMainSettingsPage}"
                     mc:Ignorable="d">
    <ScrollViewer>
        <StackPanel Margin="24,18,24,26" Spacing="14">
            <Border Background="#14FFFFFF"
                    BorderBrush="#22000000"
                    BorderThickness="1"
                    CornerRadius="12"
                    Padding="16">
                <StackPanel Spacing="10">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock FontFamily="Segoe Fluent Icons" Text="&#xE713;" FontSize="18" />
                        <TextBlock Text="Duty-Agent 设置" FontSize="20" FontWeight="Bold" />
                    </StackPanel>
                    <TextBlock Text="面向普通用户：配置排班、执行任务、管理名单。"
                               Opacity="0.75"
                               TextWrapping="Wrap" />
                    <TextBlock x:Name="StatusText"
                               Text="就绪"
                               FontWeight="SemiBold"
                               Foreground="Gray" />
                    <TextBlock x:Name="StatusMetaText"
                               Text="配置状态：未应用"
                               Opacity="0.75"
                               TextWrapping="Wrap" />
                    <TextBlock x:Name="RuntimeMetaText"
                               Text="运行状态：待命 | 数据状态：未刷新"
                               Opacity="0.75"
                               TextWrapping="Wrap" />
                </StackPanel>
            </Border>

            <Border Background="#14FFFFFF"
                    BorderBrush="#22000000"
                    BorderThickness="1"
                    CornerRadius="12"
                    Padding="16">
                <StackPanel Spacing="10">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock FontFamily="Segoe Fluent Icons" Text="&#xE7C3;" FontSize="16" />
                        <TextBlock Text="执行排班" FontSize="16" FontWeight="SemiBold" />
                    </StackPanel>
                    <TextBlock Text="排班指令" />
                    <TextBox x:Name="InstructionBox"
                             Height="76"
                             AcceptsReturn="True"
                             TextWrapping="Wrap"
                             Watermark="例如：从今天开始排5天，每个区域每天2人，周末跳过。" />
                    <Grid ColumnDefinitions="2*,*" ColumnSpacing="10">
                        <StackPanel Grid.Column="0" Spacing="6">
                            <TextBlock Text="应用模式" />
                            <ComboBox x:Name="ApplyModeComboBox" HorizontalAlignment="Stretch">
                                <ComboBoxItem Content="追加（推荐）" />
                                <ComboBoxItem Content="替换未来" />
                                <ComboBoxItem Content="替换重叠区间" />
                                <ComboBoxItem Content="全部替换" />
                            </ComboBox>
                        </StackPanel>
                        <Button Grid.Column="1"
                                x:Name="RunAgentBtn"
                                VerticalAlignment="Bottom"
                                Content="开始排班"
                                Click="OnRunAgentClick" />
                    </Grid>
                </StackPanel>
            </Border>

            <Border Background="#14FFFFFF"
                    BorderBrush="#22000000"
                    BorderThickness="1"
                    CornerRadius="12"
                    Padding="16">
                <StackPanel Spacing="10">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock FontFamily="Segoe Fluent Icons" Text="&#xE8D2;" FontSize="16" />
                        <TextBlock Text="连接与模型" FontSize="16" FontWeight="SemiBold" />
                    </StackPanel>
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                        <StackPanel Grid.Column="0" Spacing="6">
                            <TextBlock Text="API Key" />
                            <TextBox x:Name="ApiKeyBox"
                                     PasswordChar="*"
                                     LostFocus="OnConfigInputLostFocus"
                                     KeyDown="OnConfigInputKeyDown" />
                        </StackPanel>
                        <StackPanel Grid.Column="1" Spacing="6">
                            <TextBlock Text="模型" />
                            <TextBox x:Name="ModelBox"
                                     Watermark="moonshotai/kimi-k2-thinking"
                                     LostFocus="OnConfigInputLostFocus"
                                     KeyDown="OnConfigInputKeyDown" />
                        </StackPanel>
                    </Grid>
                    <TextBlock Text="Base URL" />
                    <TextBox x:Name="BaseUrlBox"
                             Watermark="https://integrate.api.nvidia.com/v1"
                             LostFocus="OnConfigInputLostFocus"
                             KeyDown="OnConfigInputKeyDown" />
                </StackPanel>
            </Border>

            <Border Background="#14FFFFFF"
                    BorderBrush="#22000000"
                    BorderThickness="1"
                    CornerRadius="12"
                    Padding="16">
                <StackPanel Spacing="10">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock FontFamily="Segoe Fluent Icons" Text="&#xE945;" FontSize="16" />
                        <TextBlock Text="AI 长期规则" FontSize="16" FontWeight="SemiBold" />
                    </StackPanel>
                    <TextBlock Text="以下内容会作为固定规则发送给 AI，每次排班都会生效。可包含排班逻辑、区域分配偏好、特殊安排等。"
                               Opacity="0.65"
                               TextWrapping="Wrap" />
                    <TextBox x:Name="DutyRuleBox"
                             Height="100"
                             AcceptsReturn="True"
                             TextWrapping="Wrap"
                             Watermark="示例：&#10;每天排班2人，跳过周末&#10;区域：教室、清洁区&#10;教室每天2人，清洁区每天3人&#10;排班周期：5天&#10;男生优先排清洁区"
                             LostFocus="OnConfigInputLostFocus"
                             KeyDown="OnConfigInputKeyDown" />
                </StackPanel>
            </Border>

            <Border Background="#14FFFFFF"
                    BorderBrush="#22000000"
                    BorderThickness="1"
                    CornerRadius="12"
                    Padding="16">
                <StackPanel Spacing="10">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock FontFamily="Segoe Fluent Icons" Text="&#xE823;" FontSize="16" />
                        <TextBlock Text="排班处理参数" FontSize="16" FontWeight="SemiBold" />
                    </StackPanel>
                    <TextBlock Text="以下参数用于控制排班的运行时处理逻辑（日期生成、结果归一化等），不会直接发送给 AI。"
                               Opacity="0.55"
                               TextWrapping="Wrap" />

                    <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                        <StackPanel Grid.Column="0" Spacing="6">
                            <TextBlock Text="自动排班日" />
                            <ComboBox x:Name="AutoRunDayComboBox"
                                      HorizontalAlignment="Stretch"
                                      SelectionChanged="OnConfigSelectionChanged">
                                <ComboBoxItem Content="周一" />
                                <ComboBoxItem Content="周二" />
                                <ComboBoxItem Content="周三" />
                                <ComboBoxItem Content="周四" />
                                <ComboBoxItem Content="周五" />
                                <ComboBoxItem Content="周六" />
                                <ComboBoxItem Content="周日" />
                            </ComboBox>
                        </StackPanel>
                        <StackPanel Grid.Column="1" Spacing="6">
                            <TextBlock Text="自动排班时间 (HH:mm)" />
                            <TextBox x:Name="AutoRunTimeBox"
                                     Watermark="08:00"
                                     LostFocus="OnConfigInputLostFocus"
                                     KeyDown="OnConfigInputKeyDown" />
                        </StackPanel>
                    </Grid>

                    <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                        <StackPanel Grid.Column="0" Spacing="6">
                            <TextBlock Text="生成天数 (1-30)" />
                            <TextBox x:Name="CoverageDaysBox"
                                     LostFocus="OnConfigInputLostFocus"
                                     KeyDown="OnConfigInputKeyDown" />
                        </StackPanel>
                        <StackPanel Grid.Column="1" Spacing="6">
                            <TextBlock Text="默认每区域每日人数 (1-30)" />
                            <TextBox x:Name="PerDayBox"
                                     LostFocus="OnConfigInputLostFocus"
                                     KeyDown="OnConfigInputKeyDown" />
                        </StackPanel>
                    </Grid>

                    <TextBlock Text="组件刷新时间 (HH:mm)" />
                    <TextBox x:Name="ComponentRefreshTimeBox"
                             Watermark="08:00"
                             LostFocus="OnConfigInputLostFocus"
                             KeyDown="OnConfigInputKeyDown" />

                    <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" ColumnSpacing="10" RowSpacing="8">
                        <ToggleSwitch x:Name="EnableAutoRunSwitch"
                                      Grid.Row="0"
                                      Grid.Column="0"
                                      Content="自动排班"
                                      Checked="OnConfigToggleChanged"
                                      Unchecked="OnConfigToggleChanged" />
                        <ToggleSwitch x:Name="SkipWeekendsSwitch"
                                      Grid.Row="0"
                                      Grid.Column="1"
                                      Content="跳过周末排班"
                                      Checked="OnConfigToggleChanged"
                                      Unchecked="OnConfigToggleChanged" />
                        <ToggleSwitch x:Name="StartFromTodaySwitch"
                                      Grid.Row="1"
                                      Grid.ColumnSpan="2"
                                      Content="从今天开始"
                                      Checked="OnConfigToggleChanged"
                                      Unchecked="OnConfigToggleChanged" />
                    </Grid>
                </StackPanel>
            </Border>

            <Border Background="#14FFFFFF"
                    BorderBrush="#22000000"
                    BorderThickness="1"
                    CornerRadius="12"
                    Padding="16">
                <StackPanel Spacing="10">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock FontFamily="Segoe Fluent Icons" Text="&#xE8FD;" FontSize="16" />
                        <TextBlock Text="值日区域与人数" FontSize="16" FontWeight="SemiBold" />
                    </StackPanel>

                    <TextBlock x:Name="AreaSummaryText"
                               Text="共 0 个值日区域。"
                               Opacity="0.75" />

                    <Border BorderBrush="#22000000" BorderThickness="1" CornerRadius="8">
                        <Grid RowDefinitions="Auto,*">
                            <Border BorderBrush="#22000000" BorderThickness="0,0,0,1" Padding="10,8">
                                <Grid ColumnDefinitions="2*,120" ColumnSpacing="8">
                                    <TextBlock Grid.Column="0" Text="区域" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="1" Text="人数" FontWeight="SemiBold" HorizontalAlignment="Right" />
                                </Grid>
                            </Border>
                            <ListBox x:Name="AreaSettingsListBox"
                                     Grid.Row="1"
                                     MinHeight="160"
                                     MaxHeight="220"
                                     SelectionChanged="OnAreaSelectionChanged">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Border Padding="10,8" BorderBrush="#14000000" BorderThickness="0,0,0,1">
                                            <Grid ColumnDefinitions="2*,120" ColumnSpacing="8">
                                                <TextBlock Grid.Column="0" Text="{Binding Name}" VerticalAlignment="Center" />
                                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                                                    <TextBlock Text="{Binding CountDisplay}"
                                                               VerticalAlignment="Center"
                                                               Cursor="Hand"
                                                               PointerPressed="OnAreaCountTextPointerPressed" />
                                                    <TextBox Width="84"
                                                             IsVisible="False"
                                                             VerticalAlignment="Center"
                                                             HorizontalContentAlignment="Center"
                                                             KeyDown="OnAreaCountEditorKeyDown"
                                                             LostFocus="OnAreaCountEditorLostFocus" />
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Grid>
                    </Border>

                    <Grid ColumnDefinitions="2*,120,Auto" ColumnSpacing="10">
                        <TextBox x:Name="NewAreaNameBox" Grid.Column="0" Watermark="新增区域名（如：走廊）" />
                        <ComboBox x:Name="NewAreaCountComboBox" Grid.Column="1" />
                        <Button x:Name="AddAreaBtn" Grid.Column="2" Content="新增区域" Click="OnAddAreaClick" />
                    </Grid>

                    <Grid ColumnDefinitions="2*,Auto,Auto" ColumnSpacing="10">
                        <TextBox x:Name="SelectedAreaNameBox" Grid.Column="0" Watermark="修改选中区域名" />
                        <Button x:Name="UpdateAreaBtn" Grid.Column="1" Content="更新选中名称" Click="OnUpdateAreaClick" IsEnabled="False" />
                        <Button x:Name="DeleteAreaBtn" Grid.Column="2" Content="删除选中" Click="OnDeleteAreaClick" IsEnabled="False" />
                    </Grid>
                </StackPanel>
            </Border>

            <Border Background="#14FFFFFF"
                    BorderBrush="#22000000"
                    BorderThickness="1"
                    CornerRadius="12"
                    Padding="16">
                <StackPanel Spacing="10">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock FontFamily="Segoe Fluent Icons" Text="&#xE716;" FontSize="16" />
                        <TextBlock Text="学生名单" FontSize="16" FontWeight="SemiBold" />
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" Spacing="10">
                        <TextBox x:Name="NewStudentNameBox"
                                 Width="220"
                                 Watermark="输入学生姓名" />
                        <Button x:Name="AddStudentBtn"
                                Content="添加学生"
                                Click="OnAddStudentClick" />
                        <Button x:Name="DeleteStudentBtn"
                                Content="删除选中"
                                Click="OnDeleteStudentClick" />
                        <Button x:Name="OpenRosterBtn"
                                Content="打开名单文件"
                                Click="OnOpenRosterClick" />
                    </StackPanel>

                    <Border BorderBrush="#22000000" BorderThickness="1" CornerRadius="8">
                        <Grid RowDefinitions="Auto,*">
                            <Border BorderBrush="#22000000" BorderThickness="0,0,0,1" Padding="10,8">
                                <Grid ColumnDefinitions="64,2*,1.8*,84,84" ColumnSpacing="8">
                                    <TextBlock Grid.Column="0" Text="ID" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="1" Text="姓名" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="2" Text="下一次值日" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="3" Text="次数" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="4" Text="状态" FontWeight="SemiBold" />
                                </Grid>
                            </Border>
                            <ListBox x:Name="RosterListBox"
                                     Grid.Row="1"
                                     MinHeight="220"
                                     MaxHeight="300">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Border Padding="10,8" BorderBrush="#14000000" BorderThickness="0,0,0,1">
                                            <Grid ColumnDefinitions="64,2*,1.8*,84,84" ColumnSpacing="8">
                                                <TextBlock Grid.Column="0"
                                                           Text="{Binding Id}"
                                                           VerticalAlignment="Center"
                                                           Opacity="0.75" />
                                                <TextBlock Grid.Column="1"
                                                           Text="{Binding Name}"
                                                           VerticalAlignment="Center"
                                                           TextTrimming="CharacterEllipsis" />
                                                <TextBlock Grid.Column="2"
                                                           Text="{Binding NextDutyDisplay}"
                                                           VerticalAlignment="Center"
                                                           TextTrimming="CharacterEllipsis" />
                                                <TextBlock Grid.Column="3"
                                                           Text="{Binding DutyCount}"
                                                           VerticalAlignment="Center" />
                                                <TextBlock Grid.Column="4"
                                                           Text="{Binding ActiveDisplay}"
                                                           VerticalAlignment="Center" />
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Grid>
                    </Border>

                    <TextBlock x:Name="RosterSummaryText"
                               Text="名单未加载。"
                               Opacity="0.75" />
                </StackPanel>
            </Border>

            <Border Background="#14FFFFFF"
                    BorderBrush="#22000000"
                    BorderThickness="1"
                    CornerRadius="12"
                    Padding="16">
                <StackPanel Spacing="10">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock FontFamily="Segoe Fluent Icons" Text="&#xE943;" FontSize="16" />
                        <TextBlock Text="调试与集成" FontSize="16" FontWeight="SemiBold" />
                    </StackPanel>
                    <ToggleSwitch x:Name="EnableMcpSwitch"
                                  Content="启用 MCP 导入接口"
                                  Checked="OnConfigToggleChanged"
                                  Unchecked="OnConfigToggleChanged" />
                    <ToggleSwitch x:Name="EnableWebDebugLayerSwitch"
                                  Content="启用 WebView2 调试层"
                                  Checked="OnConfigToggleChanged"
                                  Unchecked="OnConfigToggleChanged" />
                    <TextBlock Text="说明：启用“WebView2 调试层”后，重启 ClassIsland 才会显示调试页面并启动对应本地调试服务。"
                               Opacity="0.75"
                               TextWrapping="Wrap" />
                </StackPanel>
            </Border>

            <Border Background="#14FFFFFF"
                    BorderBrush="#22000000"
                    BorderThickness="1"
                    CornerRadius="12"
                    Padding="16">
                <StackPanel Spacing="10">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock FontFamily="Segoe Fluent Icons" Text="&#xE8A5;" FontSize="16" />
                        <TextBlock Text="排班预览" FontSize="16" FontWeight="SemiBold" />
                    </StackPanel>
                    <Button x:Name="RefreshDataBtn"
                            Content="刷新预览"
                            HorizontalAlignment="Left"
                            Click="OnRefreshDataClick" />

                    <Border BorderBrush="#22000000" BorderThickness="1" CornerRadius="8">
                        <Grid RowDefinitions="Auto,*">
                            <Border BorderBrush="#22000000" BorderThickness="0,0,0,1" Padding="10,8">
                                <Grid ColumnDefinitions="120,80,*" ColumnSpacing="8">
                                    <TextBlock Grid.Column="0" Text="日期" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="1" Text="星期" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="2" Text="值日安排" FontWeight="SemiBold" />
                                </Grid>
                            </Border>
                            <ListBox x:Name="ScheduleListBox"
                                     Grid.Row="1"
                                     MinHeight="220"
                                     MaxHeight="320">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Border Padding="10,8" BorderBrush="#14000000" BorderThickness="0,0,0,1">
                                            <Grid ColumnDefinitions="120,80,*" ColumnSpacing="8">
                                                <TextBlock Grid.Column="0"
                                                           Text="{Binding Date}"
                                                           VerticalAlignment="Center" />
                                                <TextBlock Grid.Column="1"
                                                           Text="{Binding Day}"
                                                           VerticalAlignment="Center" />
                                                <TextBlock Grid.Column="2"
                                                           Text="{Binding AssignmentSummary}"
                                                           VerticalAlignment="Center"
                                                           TextWrapping="Wrap" />
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Grid>
                    </Border>
                    <TextBlock x:Name="ScheduleSummaryText"
                               Text="暂无排班数据。"
                               Opacity="0.75" />
                </StackPanel>
            </Border>
        </StackPanel>
    </ScrollViewer>
</ci:SettingsPageBase>
