<ci:SettingsPageBase x:Class="DutyAgent.Views.SettingPages.DutyMainSettingsPage"
                     xmlns="https://github.com/avaloniaui"
                     xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                     xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                     xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                     xmlns:ci="http://classisland.tech/schemas/xaml/core"
                     xmlns:local="clr-namespace:DutyAgent.Views.SettingPages"
                     x:DataType="local:DutyMainSettingsPage"
                     d:DataContext="{d:DesignInstance local:DutyMainSettingsPage}"
                     mc:Ignorable="d">
    <ScrollViewer>
        <StackPanel Margin="24,18,24,26" Spacing="14">
            <Border Background="#14FFFFFF"
                    BorderBrush="#22000000"
                    BorderThickness="1"
                    CornerRadius="12"
                    Padding="16">
                <StackPanel Spacing="10">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock FontFamily="Segoe Fluent Icons" Text="&#xE713;" FontSize="18" />
                        <TextBlock Text="Duty-Agent 设置" FontSize="20" FontWeight="Bold" />
                    </StackPanel>
                    <TextBlock Text="面向普通用户：配置排班、执行任务、管理名单。"
                               Opacity="0.75"
                               TextWrapping="Wrap" />
                    <TextBlock x:Name="StatusText"
                               Text="就绪"
                               FontWeight="SemiBold"
                               Foreground="Gray" />
                    <TextBlock x:Name="StatusMetaText"
                               Text="配置状态：未应用"
                               Opacity="0.75"
                               TextWrapping="Wrap" />
                    <TextBlock x:Name="RuntimeMetaText"
                               Text="运行状态：待命 | 数据状态：未刷新"
                               Opacity="0.75"
                               TextWrapping="Wrap" />
                </StackPanel>
            </Border>

            <Border Background="#14FFFFFF"
                    BorderBrush="#22000000"
                    BorderThickness="1"
                    CornerRadius="12"
                    Padding="16">
                <StackPanel Spacing="10">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock FontFamily="Segoe Fluent Icons" Text="&#xE7C3;" FontSize="16" />
                        <TextBlock Text="执行排班" FontSize="16" FontWeight="SemiBold" />
                    </StackPanel>
                    <TextBlock Text="排班指令" />
                    <TextBox x:Name="InstructionBox"
                             Height="76"
                             AcceptsReturn="True"
                             TextWrapping="Wrap"
                             Watermark="请输入本次排班指令；留空将按当前配置执行默认排班。" />
                    <Button x:Name="RunAgentBtn"
                            HorizontalAlignment="Right"
                            Content="开始排班（覆盖）"
                            Click="OnRunAgentClick" />
                </StackPanel>
            </Border>

            <Border Background="#14FFFFFF"
                    BorderBrush="#22000000"
                    BorderThickness="1"
                    CornerRadius="12"
                    Padding="16">
                <StackPanel Spacing="10">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock FontFamily="Segoe Fluent Icons" Text="&#xE8D2;" FontSize="16" />
                        <TextBlock Text="连接与模型" FontSize="16" FontWeight="SemiBold" />
                    </StackPanel>
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                        <StackPanel Grid.Column="0" Spacing="6">
                            <TextBlock Text="API Key" />
                            <TextBox x:Name="ApiKeyBox"
                                     PasswordChar="*"
                                     LostFocus="OnConfigInputLostFocus"
                                     KeyDown="OnConfigInputKeyDown" />
                        </StackPanel>
                        <StackPanel Grid.Column="1" Spacing="6">
                            <TextBlock Text="模型" />
                            <TextBox x:Name="ModelBox"
                                     Watermark="moonshotai/kimi-k2-thinking"
                                     LostFocus="OnConfigInputLostFocus"
                                     KeyDown="OnConfigInputKeyDown" />
                        </StackPanel>
                    </Grid>
                    <TextBlock Text="Base URL" />
                    <TextBox x:Name="BaseUrlBox"
                             Watermark="https://integrate.api.nvidia.com/v1"
                             LostFocus="OnConfigInputLostFocus"
                             KeyDown="OnConfigInputKeyDown" />
                </StackPanel>
            </Border>

            <Border Background="#14FFFFFF"
                    BorderBrush="#22000000"
                    BorderThickness="1"
                    CornerRadius="12"
                    Padding="16">
                <StackPanel Spacing="10">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock FontFamily="Segoe Fluent Icons" Text="&#xE945;" FontSize="16" />
                        <TextBlock Text="AI 长期规则" FontSize="16" FontWeight="SemiBold" />
                    </StackPanel>
                    <TextBlock Text="以下内容会作为固定规则发送给 AI，每次排班都会生效。可包含排班逻辑、区域分配偏好、特殊安排等。"
                               Opacity="0.65"
                               TextWrapping="Wrap" />
                    <TextBox x:Name="DutyRuleBox"
                             Height="100"
                             AcceptsReturn="True"
                             TextWrapping="Wrap"
                             Watermark="示例：&#10;每天排班2人，跳过周末&#10;区域：教室、清洁区&#10;教室每天2人，清洁区每天3人&#10;排班周期：5天"
                             LostFocus="OnConfigInputLostFocus"
                             KeyDown="OnConfigInputKeyDown" />
                </StackPanel>
            </Border>

            <Border Background="#14FFFFFF"
                    BorderBrush="#22000000"
                    BorderThickness="1"
                    CornerRadius="12"
                    Padding="16">
                <StackPanel Spacing="10">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock FontFamily="Segoe Fluent Icons" Text="&#xE823;" FontSize="16" />
                        <TextBlock Text="排班处理参数" FontSize="16" FontWeight="SemiBold" />
                    </StackPanel>
                    <TextBlock Text="以下参数用于控制排班的运行时处理逻辑（日期生成、结果归一化等），不会直接发送给 AI。"
                               Opacity="0.55"
                               TextWrapping="Wrap" />

                    <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                        <StackPanel Grid.Column="0" Spacing="6">
                            <TextBlock Text="自动排班日" />
                            <ComboBox x:Name="AutoRunDayComboBox"
                                      HorizontalAlignment="Stretch"
                                      SelectionChanged="OnConfigSelectionChanged">
                                <ComboBoxItem Content="周一" />
                                <ComboBoxItem Content="周二" />
                                <ComboBoxItem Content="周三" />
                                <ComboBoxItem Content="周四" />
                                <ComboBoxItem Content="周五" />
                                <ComboBoxItem Content="周六" />
                                <ComboBoxItem Content="周日" />
                            </ComboBox>
                        </StackPanel>
                        <StackPanel Grid.Column="1" Spacing="6">
                            <TextBlock Text="自动排班时间" />
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <ComboBox x:Name="AutoRunHourComboBox"
                                          Width="88"
                                          HorizontalAlignment="Left"
                                          SelectionChanged="OnConfigSelectionChanged" />
                                <TextBlock VerticalAlignment="Center" Text="时" />
                                <ComboBox x:Name="AutoRunMinuteComboBox"
                                          Width="88"
                                          HorizontalAlignment="Left"
                                          SelectionChanged="OnConfigSelectionChanged" />
                                <TextBlock VerticalAlignment="Center" Text="分" />
                            </StackPanel>
                        </StackPanel>
                    </Grid>



                    <TextBlock Text="组件刷新时间" />
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <ComboBox x:Name="ComponentRefreshHourComboBox"
                                  Width="88"
                                  HorizontalAlignment="Left"
                                  SelectionChanged="OnConfigSelectionChanged" />
                        <TextBlock VerticalAlignment="Center" Text="时" />
                        <ComboBox x:Name="ComponentRefreshMinuteComboBox"
                                  Width="88"
                                  HorizontalAlignment="Left"
                                  SelectionChanged="OnConfigSelectionChanged" />
                        <TextBlock VerticalAlignment="Center" Text="分" />
                    </StackPanel>

                    <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="10" RowSpacing="8">
                        <ToggleSwitch x:Name="EnableAutoRunSwitch"
                                       Grid.Row="0"
                                       Grid.Column="0"
                                       Content="自动排班"
                                       Checked="OnConfigToggleChanged"
                                      Unchecked="OnConfigToggleChanged" />
                        <ToggleSwitch x:Name="StartFromTodaySwitch"
                                        Grid.Row="1"
                                        Grid.ColumnSpan="2"
                                        Content="从今天开始"
                                       Checked="OnConfigToggleChanged"
                                       Unchecked="OnConfigToggleChanged" />
                        <ToggleSwitch x:Name="AutoRunTriggerNotificationSwitch"
                                       Grid.Row="2"
                                       Grid.Column="0"
                                       Content="自动排班触发通知"
                                       Checked="OnConfigToggleChanged"
                                       Unchecked="OnConfigToggleChanged" />
                        <ToggleSwitch x:Name="DutyReminderEnabledSwitch"
                                       Grid.Row="2"
                                       Grid.Column="1"
                                       Content="启用值日定时通知"
                                       Checked="OnConfigToggleChanged"
                                       Unchecked="OnConfigToggleChanged" />
                    </Grid>
                    <TextBlock Text="值日通知时间" />
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <ComboBox x:Name="DutyReminderHourComboBox"
                                  Width="88"
                                  HorizontalAlignment="Left"
                                  SelectionChanged="OnConfigSelectionChanged" />
                        <TextBlock VerticalAlignment="Center" Text="时" />
                        <ComboBox x:Name="DutyReminderMinuteComboBox"
                                  Width="88"
                                  HorizontalAlignment="Left"
                                  SelectionChanged="OnConfigSelectionChanged" />
                        <TextBlock VerticalAlignment="Center" Text="分" />
                    </StackPanel>
                    <TextBlock Text="启用后会在设定时刻触发值日提醒通知。"
                               Opacity="0.65"
                               TextWrapping="Wrap" />
                </StackPanel>
            </Border>

            <Border Background="#14FFFFFF"
                    BorderBrush="#22000000"
                    BorderThickness="1"
                    CornerRadius="12"
                    Padding="16">
                <StackPanel Spacing="10">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock FontFamily="Segoe Fluent Icons" Text="&#xE716;" FontSize="16" />
                        <TextBlock Text="学生名单" FontSize="16" FontWeight="SemiBold" />
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" Spacing="10">
                        <TextBox x:Name="NewStudentNameBox"
                                 Width="220"
                                 Watermark="输入学生姓名" />
                        <Button x:Name="AddStudentBtn"
                                Content="添加学生"
                                Click="OnAddStudentClick" />
                        <Button x:Name="ToggleStudentActiveBtn"
                                Content="启用/停用选中"
                                IsEnabled="False"
                                Click="OnToggleStudentActiveClick" />
                        <Button x:Name="DeleteStudentBtn"
                                Content="删除选中"
                                Click="OnDeleteStudentClick" />
                        <Button x:Name="ImportRosterFromFileBtn"
                                Content="导入 txt/xlsx"
                                Click="OnImportRosterFromFileClick" />
                        <Button x:Name="OpenRosterBtn"
                                Content="打开名单文件"
                                Click="OnOpenRosterClick" />
                    </StackPanel>

                    <Border BorderBrush="#22000000" BorderThickness="1" CornerRadius="8">
                        <Grid RowDefinitions="Auto,*">
                            <Border BorderBrush="#22000000" BorderThickness="0,0,0,1" Padding="10,8">
                                <Grid ColumnDefinitions="64,2*,1.8*,84,84" ColumnSpacing="8">
                                    <TextBlock Grid.Column="0" Text="ID" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="1" Text="姓名" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="2" Text="下一次值日" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="3" Text="次数" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="4" Text="状态" FontWeight="SemiBold" />
                                </Grid>
                            </Border>
                            <ListBox x:Name="RosterListBox"
                                      Grid.Row="1"
                                      MinHeight="220"
                                      MaxHeight="300"
                                      SelectionChanged="OnRosterSelectionChanged">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Border Padding="10,8" BorderBrush="#14000000" BorderThickness="0,0,0,1">
                                            <Grid ColumnDefinitions="64,2*,1.8*,84,84" ColumnSpacing="8">
                                                <TextBlock Grid.Column="0"
                                                           Text="{Binding Id}"
                                                           VerticalAlignment="Center"
                                                           Opacity="0.75" />
                                                <TextBlock Grid.Column="1"
                                                           Text="{Binding Name}"
                                                           VerticalAlignment="Center"
                                                           TextTrimming="CharacterEllipsis" />
                                                <TextBlock Grid.Column="2"
                                                           Text="{Binding NextDutyDisplay}"
                                                           VerticalAlignment="Center"
                                                           TextTrimming="CharacterEllipsis" />
                                                <TextBlock Grid.Column="3"
                                                           Text="{Binding DutyCount}"
                                                           VerticalAlignment="Center" />
                                                <TextBlock Grid.Column="4"
                                                           Text="{Binding ActiveDisplay}"
                                                           VerticalAlignment="Center" />
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Grid>
                    </Border>

                    <TextBlock x:Name="RosterSummaryText"
                               Text="名单未加载。"
                               Opacity="0.75" />
                </StackPanel>
            </Border>

            <Border Background="#14FFFFFF"
                    BorderBrush="#22000000"
                    BorderThickness="1"
                    CornerRadius="12"
                    Padding="16">
                <StackPanel Spacing="10">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock FontFamily="Segoe Fluent Icons" Text="&#xE943;" FontSize="16" />
                        <TextBlock Text="调试与集成" FontSize="16" FontWeight="SemiBold" />
                    </StackPanel>
                    <ToggleSwitch x:Name="EnableMcpSwitch"
                                  Content="启用 MCP 导入接口"
                                  Checked="OnConfigToggleChanged"
                                  Unchecked="OnConfigToggleChanged" />
                    <ToggleSwitch x:Name="EnableWebDebugLayerSwitch"
                                  Content="启用 WebView2 调试层"
                                  Checked="OnConfigToggleChanged"
                                  Unchecked="OnConfigToggleChanged" />
                    <TextBlock Text="说明：启用“WebView2 调试层”后，重启 ClassIsland 才会显示调试页面并启动对应本地调试服务。"
                               Opacity="0.75"
                               TextWrapping="Wrap" />
                </StackPanel>
            </Border>

            <Border Background="#14FFFFFF"
                    BorderBrush="#22000000"
                    BorderThickness="1"
                    CornerRadius="12"
                    Padding="16">
                <StackPanel Spacing="10">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock FontFamily="Segoe Fluent Icons" Text="&#xE8A5;" FontSize="16" />
                        <TextBlock Text="排班预览" FontSize="16" FontWeight="SemiBold" />
                    </StackPanel>
                    <Button x:Name="RefreshDataBtn"
                            Content="刷新预览"
                            HorizontalAlignment="Left"
                            Click="OnRefreshDataClick" />

                    <Border BorderBrush="#22000000" BorderThickness="1" CornerRadius="8">
                        <Grid RowDefinitions="Auto,*">
                            <Border BorderBrush="#22000000" BorderThickness="0,0,0,1" Padding="10,8">
                                <Grid ColumnDefinitions="120,80,2.4*,1.4*" ColumnSpacing="8">
                                    <TextBlock Grid.Column="0" Text="日期" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="1" Text="星期" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="2" Text="值日安排" FontWeight="SemiBold" />
                                    <TextBlock Grid.Column="3" Text="备注" FontWeight="SemiBold" />
                                </Grid>
                            </Border>
                            <ListBox x:Name="ScheduleListBox"
                                      Grid.Row="1"
                                      MinHeight="220"
                                      MaxHeight="320"
                                      SelectionChanged="OnScheduleSelectionChanged">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Border Padding="10,8" BorderBrush="#14000000" BorderThickness="0,0,0,1">
                                            <Grid ColumnDefinitions="120,80,2.4*,1.4*" ColumnSpacing="8">
                                                <TextBlock Grid.Column="0"
                                                           Text="{Binding Date}"
                                                           VerticalAlignment="Center" />
                                                <TextBlock Grid.Column="1"
                                                           Text="{Binding Day}"
                                                           VerticalAlignment="Center" />
                                                <TextBlock Grid.Column="2"
                                                           Text="{Binding AssignmentSummary}"
                                                           VerticalAlignment="Center"
                                                            TextWrapping="Wrap" />
                                                <TextBlock Grid.Column="3"
                                                           Text="{Binding Note}"
                                                           VerticalAlignment="Center"
                                                           TextWrapping="Wrap" />
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Grid>
                    </Border>
                    <Border BorderBrush="#22000000" BorderThickness="1" CornerRadius="8" Padding="12" Margin="0,2,0,0">
                        <StackPanel Spacing="8">
                            <TextBlock Text="手动编辑选中日期值日安排" FontWeight="SemiBold" />
                            <TextBlock x:Name="SelectedScheduleMetaText"
                                       Text="请先在上方列表选择一条排班记录。"
                                       Opacity="0.75"
                                       TextWrapping="Wrap" />
                            <Grid ColumnDefinitions="2*,1*" ColumnSpacing="8">
                                <StackPanel Grid.Column="0" Spacing="4">
                                    <TextBlock Text="日期（yyyy-MM-dd）" />
                                    <TextBox x:Name="ScheduleDateEditorBox"
                                             Watermark="2026-02-17" />
                                </StackPanel>
                                <StackPanel Grid.Column="1" Spacing="4">
                                    <TextBlock Text="星期" />
                                    <ComboBox x:Name="ScheduleDayEditorComboBox"
                                              HorizontalAlignment="Stretch" />
                                </StackPanel>
                            </Grid>
                            <TextBlock Text="值日安排（每行一个区域，格式：区域: 姓名1, 姓名2）" />
                            <TextBox x:Name="ScheduleAssignmentsEditorBox"
                                     Height="96"
                                     AcceptsReturn="True"
                                     TextWrapping="Wrap"
                                     Watermark="示例：&#10;教室: 张三, 李四&#10;清洁区: 王五" />
                            <TextBlock Text="备注（将拼接在值日通知句尾，使用英文逗号连接）" />
                            <TextBox x:Name="ScheduleNoteEditorBox"
                                     TextWrapping="Wrap"
                                     Watermark="示例：记得带抹布" />
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <Button x:Name="SaveScheduleEditBtn"
                                        Content="保存当前排班编辑"
                                        IsEnabled="False"
                                        Click="OnSaveScheduleEditClick" />
                                <Button x:Name="ReloadScheduleEditBtn"
                                        Content="重新载入选中项"
                                        Click="OnReloadScheduleEditClick" />
                                <Button x:Name="CreateScheduleEditBtn"
                                        Content="新建值日"
                                        Click="OnCreateScheduleEditClick" />
                            </StackPanel>
                        </StackPanel>
                    </Border>
                    <TextBlock x:Name="ScheduleSummaryText"
                               Text="暂无排班数据。"
                               Opacity="0.75" />
                </StackPanel>
            </Border>
        </StackPanel>
    </ScrollViewer>
</ci:SettingsPageBase>
